gGimText = "field_text"

function Prcs_d0501_StuckElvEvent_01()
  Flg.Set("FLAG_GIMMICK_D05_040")
  ColOff("plan_cl_8002")
  Obj:new(OGIM, "elv_icon2"):CancelInvisible()
end

function Prcs_d0501_OpenShutter_05()
  Obj:new(NPC, "kokuwa_a"):Invisible(9)
  require("d05_04")
  d05_04("gim_0051")
  Field_InvisibleFollowerAllPartyMember(0, 10, false)
  Field_InvisibleFollowerAllGuest(0, 10, false)
  Obj:new(PLAYER, ""):Invisible(10)
  local pos_aim = Field.GetLocatorPosition("gim_0051")
  FieldObjectSync(FOR_ALL, false)
  WaitFrame(10)
  Obj:new(PLAYER, ""):CancelInvisible(10)
  Cam.Inst:Set(73.26, -43.43, 16.82, 63.33, -44.62, 16.7, default, 30)
  WaitFrame(30)
  Motion.Gimmick:Play("gim_0050", "e001", false)
  PlaySE(201005, 100)
  WaitFrame(60)
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
  SetEnableGimmickCheck("gim_0050", false)
  Cam.Inst:Clear(15)
end

function Prcs_d0502_PlayerModelChange()
  SetProhibitPlayerOnlyOperate(false)
  Fade.Out(0, Util.SecondFromFrame(30))
  WaitFrame(30)
  Flg.Clear("FLAG_IS_CHANGE_AEGIOMON")
  Obj:new(NPC, "hero_door_0002"):Invisible()
  Obj:new(NPC, "heroine_door_0002"):Invisible(30)
  CancelPlayerModelChange()
  WaitFrame(10)
  CheckSyncPlayerModel(false)
  Field_CancelInvisibleFollowerAllPartyMember(0, 0, false, false)
  SetProhibitDigimonRide(false)
  Field.SetFollowerCameraOperateRotationX(0)
  Cam.Inst:Clear(0)
  Flg.Set("FLAG_GIMMICK_D05_170")
  Fade.In(0, Util.SecondFromFrame(30))
end

function Prcs_d0502_StartDuctEvent(start_loc, end_loc)
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Field_InvisibleFollowerAllGuest(0, 0, false)
  SetProhibitPlayerOnlyOperate(true)
  SetEnableGimmickCheck(start_loc, false)
  SetEnableGimmickCheck(end_loc, false)
  Obj:new(PLAYER, ""):Invisible()
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Motion.Player:ChangeMoveAnim("duct", 1.5)
  SetPlayerLocator(end_loc)
  CameraSwitchChangeByFileName(CAM_FILE_DUCT, "followcam_loc_01_01", false)
  Field_SetEnvironmentSettings("es_d0502_duct01")
  FadeInWithWait(0, 30)
  Flg.Set("FLAG_GIMMICK_D05_080")
  Flg.Set("FLAG_IS_DUCT")
  PlayerModelChange(AEGIOMON)
  WaitFrame(5)
  Flg.Set("FLAG_GIMMICK_D05_490")
end

function Prcs_d0502_DuctAccessIsEntrance(is_entrance)
  if is_entrance == true then
    SetEnableGimmickCheck("gim_0050", true)
    SetEnableGimmickCheck("gim_0057", true)
    SetEnableGimmickCheck("gim_0060", true)
    SetEnableGimmickCheck("gim_0051", false)
    SetEnableGimmickCheck("gim_0058", false)
    SetEnableGimmickCheck("gim_0059", false)
    SetEnableGimmickCheck("gim_0061", false)
    Flg.Set("FLAG_GIMMICK_D05_480")
  else
    SetEnableGimmickCheck("gim_0050", false)
    SetEnableGimmickCheck("gim_0057", false)
    SetEnableGimmickCheck("gim_0060", false)
    SetEnableGimmickCheck("gim_0051", true)
    SetEnableGimmickCheck("gim_0058", true)
    SetEnableGimmickCheck("gim_0059", true)
    SetEnableGimmickCheck("gim_0061", true)
    Flg.Clear("FLAG_GIMMICK_D05_480")
  end
end

function Prcs_d0502_DuctAccessAllOff()
  SetEnableGimmickCheck("gim_0050", false)
  SetEnableGimmickCheck("gim_0057", false)
  SetEnableGimmickCheck("gim_0060", false)
  SetEnableGimmickCheck("gim_0051", false)
  SetEnableGimmickCheck("gim_0058", false)
  SetEnableGimmickCheck("gim_0059", false)
  SetEnableGimmickCheck("gim_0061", false)
end

function Prcs_d0502_MoveCraneEvent_01()
  if not Flg.Check("FLAG_GIMMICK_D05_110") then
    require("d05_04")
    d05_04("gim_0001")
  end
  SetControlScriptExternalVariable("chr609_Crane01_state", "turn")
  if Flg.Check("FLAG_GIMMICK_D05_090") then
    Obj:new(PLAYER, ""):Invisible(10)
    Field_InvisibleFollowerAllPartyMember(0, 10, false)
    Field_InvisibleFollowerAllGuest(0, 10, false)
    Cam.Inst:Set(15.91, 7.46, 83.1, 7.85, 11.94, 86.96, default, 30)
    Obj:new(NPC, "kokuwa_01"):Invisible(20)
    WaitFrame(10)
    Obj:new(PLAYER, ""):CancelInvisible(10)
    Obj:new(NPC, "npc_801"):CancelInvisible(10)
    local pos = Field.GetLocatorPosition("gim_0001")
    local index = GetIndex(FLD_OBJ_NPC, "npc_801")
    Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 270, 0)
    Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x - 1.2, pos.y, pos.z)
    Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
    Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 90, 0)
    Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, pos.x - 1.8, pos.y, pos.z + 1)
    Prcs_d05_MoveCrane("gim_0001", "e002", "obj_0001", "e002", "wall_cl_1000", "wall_cl_1001")
    ColOn("wall_cl_1011")
    Flg.Clear("FLAG_GIMMICK_D05_090")
  else
    Obj:new(PLAYER, ""):Invisible(10)
    Field_InvisibleFollowerAllPartyMember(0, 10, false)
    Field_InvisibleFollowerAllGuest(0, 10, false)
    Cam.Inst:Set(15.91, 7.46, 83.1, 7.85, 11.94, 86.96, default, 30)
    Obj:new(NPC, "kokuwa_01"):Invisible(20)
    WaitFrame(10)
    Obj:new(PLAYER, ""):CancelInvisible(10)
    Obj:new(NPC, "npc_801"):CancelInvisible(10)
    local pos = Field.GetLocatorPosition("gim_0001")
    local index = GetIndex(FLD_OBJ_NPC, "npc_801")
    Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 270, 0)
    Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x - 1.2, pos.y, pos.z)
    Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
    Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 90, 0)
    Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, pos.x - 1.8, pos.y, pos.z + 1)
    Prcs_d05_MoveCrane("gim_0001", "e001", "obj_0001", "e001", "wall_cl_1001", "wall_cl_1000")
    ColOff("wall_cl_1011")
    Flg.Set("FLAG_GIMMICK_D05_090")
  end
  Cam.Inst:Clear(30)
  WaitFrame(30)
  if Flg.Check("FLAG_GIMMICK_D05_110") then
    Obj:new(NPC, "npc_801"):Invisible(30)
    Obj:new(NPC, "kokuwa_01"):CancelInvisible(60)
  end
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
end

function Prcs_d0502_MoveCraneEvent_02()
  if not Flg.Check("FLAG_GIMMICK_D05_180") then
    require("d05_04")
    d05_04("gim_0002")
  end
  if Flg.Check("FLAG_GIMMICK_D05_100") then
    Field_InvisibleFollowerAllPartyMember(0, 10, false)
    Field_InvisibleFollowerAllGuest(0, 10, false)
    Obj:new(PLAYER, ""):Invisible(10)
    Cam.Inst:Set(27, 2.2, -39.3, 32.6, 9.3, -35, default, 30)
    Obj:new(NPC, "kokuwa_02"):Invisible(20)
    WaitFrame(10)
    Obj:new(PLAYER, ""):CancelInvisible(10)
    Obj:new(NPC, "npc_801"):CancelInvisible(10)
    local pos = Field.GetLocatorPosition("gim_0002")
    local index = GetIndex(FLD_OBJ_NPC, "npc_801")
    Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 90, 0)
    Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x + 1.2, pos.y, pos.z)
    Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
    Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 270, 0)
    Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, pos.x + 1.8, pos.y, pos.z + 1)
    Prcs_d05_MoveCrane("gim_0002", "e002", "obj_0002", "e001", "wall_cl_1002", "wall_cl_1003")
    ColOff("wall_cl_1012")
    Flg.Clear("FLAG_GIMMICK_D05_100")
  else
    Field_InvisibleFollowerAllPartyMember(0, 10, false)
    Field_InvisibleFollowerAllGuest(0, 10, false)
    Obj:new(PLAYER, ""):Invisible(10)
    Cam.Inst:Set(27, 2.2, -39.3, 32.6, 9.3, -35, default, 30)
    Obj:new(NPC, "kokuwa_02"):Invisible(20)
    WaitFrame(10)
    Obj:new(PLAYER, ""):CancelInvisible(10)
    Obj:new(NPC, "npc_801"):CancelInvisible(10)
    local pos = Field.GetLocatorPosition("gim_0002")
    local index = GetIndex(FLD_OBJ_NPC, "npc_801")
    Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 90, 0)
    Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x + 1.2, pos.y, pos.z)
    Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
    Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 270, 0)
    Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, pos.x + 1.8, pos.y, pos.z + 1)
    Prcs_d05_MoveCrane("gim_0002", "e001", "obj_0002", "e002", "wall_cl_1003", "wall_cl_1002")
    ColOn("wall_cl_1012")
    Flg.Set("FLAG_GIMMICK_D05_100")
  end
  Cam.Inst:Clear(30)
  WaitFrame(30)
  if Flg.Check("FLAG_GIMMICK_D05_180") then
    Obj:new(NPC, "npc_801"):Invisible(10)
    Obj:new(NPC, "kokuwa_02"):CancelInvisible(60)
  end
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
end

function Prcs_d0502_OpenShutter_04()
  require("d05_04")
  d05_04("gim_0016")
  Obj:new(PLAYER, ""):Invisible(10)
  Field_InvisibleFollowerAllPartyMember(0, 10, false)
  Field_InvisibleFollowerAllGuest(0, 10, false)
  local pos_aim = Field.GetLocatorPosition("gim_0017")
  Cam.Inst:Set(pos_aim.x, pos_aim.y, pos_aim.z, pos_aim.x, pos_aim.y + 4, pos_aim.z + 9, default, 30)
  WaitFrame(10)
  Obj:new(NPC, "npc_801"):CancelInvisible(10)
  Obj:new(PLAYER, ""):CancelInvisible(10)
  local pos = Field.GetLocatorPosition("gim_0016")
  local index = GetIndex(FLD_OBJ_NPC, "npc_801")
  Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 180, 0)
  Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x, pos.y, pos.z + 1.2)
  Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
  Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
  Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 0, 0)
  Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, pos.x + 1.2, pos.y, pos.z + 1.8)
  WaitFrame(30)
  Motion.Gimmick:Play("gim_0017", "e001", false)
  PlaySE(201005, 100)
  ColOff("wall_cl_0005")
  WaitFrame(60)
  Obj:new(NPC, "npc_801"):Invisible(10)
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
  Cam.Inst:Clear(30)
  Flg.Set("FLAG_GIMMICK_D05_060")
  SetEnableGimmickCheck("gim_0010", false)
  SetEnableGimmickCheck("gim_0006", false)
end

function Prcs_d0502_OpenShutter_05()
  require("d05_04")
  d05_04("gim_0003")
  Field_InvisibleFollowerAllPartyMember(0, 10, false)
  Field_InvisibleFollowerAllGuest(0, 10, false)
  Obj:new(PLAYER, ""):Invisible(10)
  local pos_aim = Field.GetLocatorPosition("gim_0011")
  Cam.Inst:Set(pos_aim.x, pos_aim.y, pos_aim.z, pos_aim.x + 3, pos_aim.y + 4, pos_aim.z - 9, default, 30)
  WaitFrame(10)
  Obj:new(NPC, "npc_801"):CancelInvisible(10)
  Obj:new(PLAYER, ""):CancelInvisible(10)
  local pos = Field.GetLocatorPosition("gim_0003")
  local index = GetIndex(FLD_OBJ_NPC, "npc_801")
  Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 90, 0)
  Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x + 1.2, pos.y, pos.z)
  Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
  Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
  Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 270, 0)
  Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, pos.x + 1.8, pos.y, pos.z - 1.2)
  WaitFrame(30)
  Motion.Gimmick:Play("gim_0011", "e001", false)
  PlaySE(201005, 100)
  ColOff("wall_cl_0001")
  WaitFrame(60)
  Obj:new(NPC, "npc_801"):Invisible(10)
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
  Cam.Inst:Clear(30)
  Flg.Set("FLAG_GIMMICK_D05_140")
  SetEnableGimmickCheck("gim_0008", false)
  SetEnableGimmickCheck("gim_0005", false)
end

function Prcs_d0503_RepairmanAdvice()
  Cam.Inst:Set(-65.4, -0.3, -37.8, -56.8, 3.9, -35, default, 0)
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Field_InvisibleFollowerAllGuest(0, 0, false)
  WaitFrame(20)
  Field_Talk_Start("d05", 1)
  Message(40502010)
  Message(40502020)
  Field_Talk_End()
  Field_CancelInvisibleFollowerAllGuest(0, 0, false, false)
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Cam.Inst:Clear(0)
  SetControlScriptExternalVariable("repairman_state", "advice_end")
end

function Prcs_d0503_GuideMessage()
  PlayerCheckGimmick("gim_0001", 10, "fg07_m01", 0, false)
  WaitFrame(30)
  Field_Talk_Start(gGimText, 1)
  Message(5400)
  Field_Talk_End()
  Field.SetEnableGimmickCheck("gim_0001", false)
  Field.SetEnableGimmickCheck("fa_0005", true)
end

function Prcs_d0503_StartUpShaftEvent()
  WaitFrame(35)
  Quake_Start(0.03, 0, 30)
  WaitFrame(35)
  Cam.Inst:Set(-45.3, 7.5, 13.1, -54.9, 9.4, 14.1, default, 30)
  WaitFrame(15)
  Motion.Gimmick:Play("obj_0001", "e002", false)
  Motion.Gimmick:WaitFrame("obj_0001", "e002", -30)
  ColOff("plan_cl_0001")
  ColOff("plan_cl_0002")
  ColOn("plan_cl_0003")
  ColOn("plan_cl_0004")
  Flg.Set("FLAG_GIMMICK_D05_210")
  Cam.Inst:Clear(30)
  WaitFrame(30)
end

function Prcs_d0503_OperateShaftGim(gim_id)
  Field_Talk_Start(gGimText, 1)
  Message(1050300001)
  MessageTalkSel(2, 3550)
  local result = Talk.GetResultSelectedNum()
  if result == RESULT_TALK00 then
    Field_Talk_End()
    if gim_id == 1 then
      PlayerCheckGimmick("gim_0001", 10, "fg07_u01", 0, false)
      WaitFrame(10)
      Cam.Inst:Set(-45.3, 7.5, 13.1, -54.9, 9.4, 14.1, default, 30)
      WaitFrame(15)
    elseif gim_id == 2 then
      PlayerCheckGimmick("gim_0002", 10, "fg07_u01", 0, false)
      WaitFrame(10)
      Cam.Inst:Set(26.5, 9.7, 22.8, 29.1, 12, 32.2, default, 30)
      WaitFrame(15)
    elseif gim_id == 3 then
      PlayerCheckGimmick("gim_0003", 10, "fg07_m01", 0, false)
      WaitFrame(10)
      Cam.Inst:Set(47.04, 3.17, -1.18, 55.66, 4.42, 3.72, default, 30)
      WaitFrame(15)
    end
    if not Flg.Check("FLAG_GIMMICK_D05_210") then
      Motion.Gimmick:Play("obj_0001", "e002", false)
      Motion.Gimmick:WaitFrame("obj_0001", "e002", -30)
      ColOff("plan_cl_0001")
      ColOff("plan_cl_0002")
      ColOn("plan_cl_0003")
      ColOn("plan_cl_0004")
      Flg.Set("FLAG_GIMMICK_D05_210")
    else
      Motion.Gimmick:Play("obj_0001", "e001", false)
      Motion.Gimmick:WaitFrame("obj_0001", "e001", -30)
      ColOff("plan_cl_0003")
      ColOff("plan_cl_0004")
      ColOn("plan_cl_0001")
      ColOn("plan_cl_0002")
      Flg.Clear("FLAG_GIMMICK_D05_210")
    end
    Cam.Inst:Clear(30)
    WaitFrame(30)
  elseif result == RESULT_TALK01 then
    Field_Talk_End()
  end
end

function Prcs_d0503_OpenSteamEngineDoor_01()
  Cam.Inst:Set(-60.1, 2.8, -29, -57.2, 6.1, -20, default, 30)
  WaitFrame(30)
  PlaySE(201005, 100)
  Motion.Gimmick:Play("obj_0002", "e001", false)
  WaitFrame(80)
  ColOff("wall_cl_0003")
  SetEnableGimmickCheck("obj_0002", false)
  Flg.Set("FLAG_GIMMICK_D05_220")
end

function Prcs_d0503_OpenSteamEngineDoor_02()
  Cam.Inst:Set(-55.7, 6.7, 49.6, -64.2, 11.1, 52.7, default, 30)
  WaitFrame(30)
  SetControlScriptExternalVariable("pos_adjust_state", "cut2")
  PlaySE(201005, 100)
  Motion.Gimmick:Play("obj_0003", "e001", false)
  WaitFrame(80)
  ColOff("wall_cl_0004")
  SetEnableGimmickCheck("obj_0003", false)
  Cam.Inst:Clear(0)
  Flg.Set("FLAG_GIMMICK_D05_230")
end

function Prcs_d0503_OpenSteamEngineDoor_03()
  PlayerCheckGimmick("gim_0013", 10, "fg07_m01", 0, false)
  Field_Talk_Start(gGimText, 1)
  Message(1050300002)
  Field_Talk_End()
  WaitFrame(20)
  Cam.Inst:Set(68.2, 5.2, -62.7, 65.1, 9.5, -54.2, 30, 30)
  WaitFrame(30)
  PlaySE(201005, 100)
  Motion.Gimmick:Play("obj_0004", "e001", false)
  WaitFrame(80)
  ColOff("wall_cl_0006")
  SetEnableGimmickCheck("gim_0013", false)
  Obj:new(NPC, "Guest_raidramon"):CancelInvisible()
  SetControlScriptExternalVariable("guest_raidramon_state", "replace")
  SetProhibitDigimonRide(true)
  Field_InvisibleFollowerAllGuest(0, 0, false)
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Field.ResetPlayer(65.8, -2, -54.1, 0)
  WaitFrame(40)
  Cam.Inst:Set(66.3, -2, -56.5, 62.2, 2.2, -48.4, 30, 0)
  Field_Talk_Start("d05", 1)
  Message(40701050)
  Field_Talk_End()
  Guest.Delete(21391)
  FadeOutWithWait(0, 30)
  Cam.Inst:Clear(0)
  Obj:new(NPC, "Guest_raidramon"):Invisible()
  Field.CheckSyncFollower()
  Field_CancelInvisibleFollowerAllGuest(0, 0, false, false)
  Field_CancelInvisibleFollowerAllPartyMember(0, 0, false, false)
  FadeInWithWait(0, 30)
  SetProhibitDigimonRide(false)
  Flg.Set("FLAG_GIMMICK_D05_470")
end

function Prcs_d0503_CoverAction(degree_y, place, gim_loc)
  Field.SetEnableGimmickCheck("gim_0020", false)
  Field.SetEnableGimmickCheck("gim_0022", false)
  Field.SetEnableGimmickCheck("gim_0023", false)
  Field.SetEnableGimmickCheck("gim_0025", false)
  local CollisionTable = {
    "plan_cl_1010",
    "plan_cl_1011",
    "plan_cl_1012",
    "plan_cl_1013",
    "plan_cl_1014",
    "plan_cl_1015",
    "plan_cl_1016",
    "plan_cl_1017",
    "plan_cl_1018",
    "plan_cl_1019",
    "plan_cl_1020"
  }
  ColOffWithTable(CollisionTable)
  Motion.Player:ChangeMoveAnimWithBlend("cover", 10, 10)
  SetControlScriptExternalVariable("hide_action_state", "start")
  SetControlScriptExternalVariable("degree_y", degree_y)
  WaitFrame(20)
  SetControlScriptExternalVariable("player_hide_state", place)
end

function Prcs_d0503_CoverActionEnd()
  local CollisionTable = {
    "plan_cl_1010",
    "plan_cl_1011",
    "plan_cl_1012",
    "plan_cl_1013",
    "plan_cl_1014",
    "plan_cl_1015",
    "plan_cl_1016",
    "plan_cl_1017",
    "plan_cl_1018",
    "plan_cl_1019",
    "plan_cl_1020"
  }
  Motion.Player:ChangeMoveAnimWithBlend("cover_end", 3, 2.5)
  WaitFrame(3)
  Motion.Player:ChangeMoveAnimWithBlend("hide", 3, 2.5)
  WaitFrame(3)
  ColOnWithTable(CollisionTable)
  Field.SetEnableGimmickCheck("gim_0020", true)
  Field.SetEnableGimmickCheck("gim_0022", true)
  Field.SetEnableGimmickCheck("gim_0023", true)
  Field.SetEnableGimmickCheck("gim_0025", true)
end

function Prcs_d0503_StealthFailed()
  SetControlScriptExternalVariable("player_state", "failed")
  Motion.NPC:Play("chr214_observe", "ba02", 0, false)
  WaitFrame(60)
  SetControlScriptExternalVariable("player_hide_state", "end")
  SetControlScriptExternalVariable("player_state", "end")
  SetControlScriptExternalVariable("chr214_observe_state", "end")
  Flg.Set("FLAG_GIMMICK_D05_450")
  EncountFromField(30503299, 10572, false)
end

function Prcs_d0503_BattleStart()
  Field_Talk_End()
  SetProhibitDigimonRide(true)
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Field_InvisibleFollowerAllGuest(0, 0, false)
  SetControlScriptExternalVariable("chr214_observe_state", "battle")
  WaitFrame(1)
  Motion.NPC:Play("chr214_observe", "ba02", 0, false)
  WaitFrame(1)
  Field.ResetPlayer(69.4, -1.8, 16.7, 350)
  Cam.Inst:Set(65.5, 1.8, 10.6, 71.7, -1.2, 17.8, default, 0)
  WaitFrame(16)
  Motion.Player:Play("e018", 0, false)
  WaitFrame(50)
  Flg.Set("FLAG_GIMMICK_D05_450")
  EncountFromField(30503299, 10572, false)
end

function Prcs_d0503_HideFromEnemy(dest_loc)
  Field_Talk_End()
  SetProhibitDigimonRide(true)
  Cam.Inst:Clear(30)
  WaitFrame(35)
  local CollisionTable = {
    "plan_cl_1010",
    "plan_cl_1011",
    "plan_cl_1012",
    "plan_cl_1013",
    "plan_cl_1014",
    "plan_cl_1015",
    "plan_cl_1016",
    "plan_cl_1017",
    "plan_cl_1018",
    "plan_cl_1019",
    "plan_cl_1020",
    "plan_cl_1021",
    "plan_cl_1022",
    "plan_cl_1023"
  }
  SetPlayerStealthFromSymbolEnemy(true)
  SetControlScriptExternalVariable("player_state", "hide")
  Motion.Player:ChangeMoveAnimWithBlend("hide", 10, 2.5)
  Field_InvisibleFollowerAllGuest(0, 0, false)
  Field_InvisibleFollowerAllPartyMember(0, 5, false)
  WaitFrame(10)
  Flg.Set("FLAG_GIMMICK_D05_290")
  Field.MovePlayerToLocatorFrame(dest_loc, 60)
  WaitFrame(10)
  CameraSwitchChange("railcam_loc_01_01", true)
  WaitFrame(70)
  ColOnWithTable(CollisionTable)
end

function Prcs_d0503_CanselHideFromEnemy(locator_name)
  local CollisionTable = {
    "plan_cl_1010",
    "plan_cl_1011",
    "plan_cl_1012",
    "plan_cl_1013",
    "plan_cl_1014",
    "plan_cl_1015",
    "plan_cl_1016",
    "plan_cl_1017",
    "plan_cl_1018",
    "plan_cl_1019",
    "plan_cl_1020",
    "plan_cl_1021",
    "plan_cl_1022",
    "plan_cl_1023"
  }
  ColOffWithTable(CollisionTable)
  SetPlayerStealthFromSymbolEnemy(false)
  CameraSwitchChange("followcam_default_loc", true)
  WaitFrame(5)
  SetControlScriptExternalVariable("player_state", "end")
  Motion.Player:ResetMoveAnimationWithBlend(10)
  WaitFrame(5)
  MovePlayerToLocatorFrame(locator_name, 45)
  SetProhibitDigimonRide(false)
  Flg.Clear("FLAG_GIMMICK_D05_290")
  Field_CancelInvisibleFollowerAllGuest(0, 30, false, false)
  Field_CancelInvisibleFollowerAllPartyMember(0, 30, false, false)
end

function Prcs_d0503_RemoveDebris()
  FadeOutWithWait(0, 30)
  Cam.Inst:Set(-81.9, 1.2, 12.8, -85.4, 6.5, 5, default, 0)
  FadeInWithWait(0, 30)
  WaitFrame(30)
  FadeOutWithWait(1, 15)
  Field.InvisibleGimmick("obj_0005", 0, 0, false)
  ColOff("wall_cl_0005")
  Motion.NPC:Play("chr595_miner_01", "bv01", 0, true)
  Motion.NPC:Play("chr595_miner_02", "fe02", 0, true)
  Motion.NPC:Play("chr595_miner_03", "fe03", 0, true)
  PlaySE(202001, 100)
  WaitFrame(25)
  local index = GetIndex(FLD_OBJ_LOCATOR, "sp_0001")
  AttachAndStartEffectScript(FLD_OBJ_LOCATOR, index, "ef_f_com_300_sm", false, 1, false, false, false, false)
  WaitFrame(5)
  FadeInWithWait(1, 15)
  WaitFrame(90)
  Cam.Inst:Clear(0)
  Flg.Set("FLAG_GIMMICK_D05_270")
  SetControlScriptExternalVariable("miner01_state", "move_to_door")
  SetControlScriptExternalVariable("miner02_state", "move_to_door")
  SetControlScriptExternalVariable("miner03_state", "move_to_door")
end

function Prcs_d05_Digmonride(locator, item_id, item_number)
  Field_Talk_Start(gGimText, 1)
  if Common.IsExistGuest(21441) then
    Message(1050400003)
    MessageTalkSel(2, 1050400004)
    local result = Talk.GetResultSelectedNum()
    if result == RESULT_TALK00 then
      Message(1050400006)
      FadeOutWithWait(0, 15)
      Motion.Gimmick:Play(locator, "e001", false)
      FadeInWithWait(0, 15)
      INFO_GET_ITEM(item_id, item_number)
      SetEnableGimmickCheck(locator, false)
    elseif result == RESULT_TALK01 then
    end
  else
    Message(1050300010)
  end
  Field_Talk_End()
end

function Prcs_d0504_StuckElvEvent_01()
  Field_Talk_Start(gGimText, 1)
  Message(1050400011)
  Field_Talk_End()
end

function Prcs_d0505_OpenControlRoomDoor()
  SetEnableGimmickCheck("gim_0001", false)
  Field_InvisibleFollowerAllPartyMember(0, 10, false)
  Field_InvisibleFollowerAllGuest(0, 10, false)
  require("d05_04")
  d05_04("gim_0002")
  d05_04("gim_0003")
  Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 0, 0)
  PlayerObjectResetAim()
  Obj:new(NPC, "Kokuwa_A"):CancelInvisible()
  Obj:new(NPC, "Kokuwa_UN"):CancelInvisible()
  local pos = Field.GetLocatorPosition("gim_0002")
  local index = GetIndex(FLD_OBJ_NPC, "Kokuwa_A")
  Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 180, 0)
  Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x, pos.y, pos.z + 1.2)
  Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
  Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
  local pos = Field.GetLocatorPosition("gim_0003")
  local index = GetIndex(FLD_OBJ_NPC, "Kokuwa_UN")
  Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 180, 0)
  Field.ObjectSetPos(FLD_OBJ_NPC, index, pos.x, pos.y, pos.z + 1.2)
  Field.ObjectLoadMotion(FLD_OBJ_NPC, index, "f001")
  Field.ObjectPlayMotion(FLD_OBJ_NPC, index, "f001", 5, true)
  WaitFrame(30)
  Cam.Inst:Set(0.03, 2.304, 26.898, 0.317, 0.36, 36.703, default, 300)
  Motion.Gimmick:Play("gim_0001", "e001", false)
  local se_slot = PlaySE(201009, 100)
  Motion.Gimmick:WaitFrame("gim_0001", "e001", 0)
  StopSE(se_slot, 30)
  PlaySE(201019, 100)
  ColOff("wall_cl_0001")
  Field_CancelInvisibleFollowerAllPartyMember(1, 30, true, true)
  Flg.Set("FLAG_GIMMICK_D05_360")
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
end

function Prcs_d05_OpenSlideDoor(gim_id, cl_name)
  SetEnableGimmickCheck(gim_id, false)
  PlayerCheckGimmick(gim_id, 10, "fg07_m02", 0, false)
  WaitFrame(30)
  PlaySE(201005, 100)
  Motion.Gimmick:Play(gim_id, "e001", false)
  WaitFrame(60)
  ColOff(cl_name)
end

function Prcs_d05_MoveCrane(gim_loc, gim_anim, obj_loc, obj_anim, offcol, oncol)
  WaitFrame(30)
  Motion.Gimmick:Play(obj_loc, obj_anim, false)
  if obj_anim == "e001" or obj_anim == "e002" then
    PlaySE(201004, 100)
  elseif obj_anim == "e003" or obj_anim == "e004" then
    PlaySE(201004, 100)
  end
  WaitFrame(240)
  if offcol ~= "" then
    ColOff(offcol)
  end
  if oncol ~= "" then
    ColOn(oncol)
  end
end

function Prcs_d05_Teleport(go_prefix, go_map_num, locator, efflocator)
  local map_num, map_prefix = Field.GetMapNumber(), Field.GetMapPrefix()
  if map_num < 1000 then
    local effp_data = map_prefix .. "0" .. tostring(map_num) .. "p"
  else
    local effp_data = map_prefix .. tostring(map_num) .. "p"
  end
  print("to ", go_prefix, tostring(go_map_num), " ", locator)
  local index = GetIndex(FLD_OBJ_LOCATOR, efflocator)
  AttachAndStartEffectScript(FLD_OBJ_LOCATOR, index, "ef_f_com_120_ga", false, 1, false, false, false, false)
  WaitFrame(30)
  MapChange(go_prefix, go_map_num, locator, true, 0, 0)
end

function Prcs_d05_ParkGate_In(in_degree_y, in_frame, return_degree_y, return_frame, point, col1, col2)
  local FREEPASS = 733
  local TICKET = 732
  ColOn(col1)
  ColOn(col2)
  if Item.GetNum(FREEPASS) >= 1 then
    local tlk = Tlk:new("d05", 1, false)
    tlk:StartTalk()
    if point == 1 then
      tlk:Message("f_d0501_0220_0010")
      tlk:Message("f_d0501_0220_0020")
      tlk:Message("f_d0501_0220_0030")
    elseif point == 2 then
      tlk:Message("f_d0501_0220_0012")
      tlk:Message("f_d0501_0220_0020")
      tlk:Message("f_d0501_0220_0032")
    elseif point == 3 then
      tlk:Message("f_d0501_0220_0014")
      tlk:Message("f_d0501_0220_0020")
      tlk:Message("f_d0501_0220_0034")
      tlk:MessageClose()
      Field_InvisibleFollowerAllPartyMember(0, 15, false)
      Field_InvisibleFollowerAllGuest(0, 15, false)
      Cam.Inst:Set(75.422, -44.953, 16.657, 65.73, -42.49, 16.62, default, 30)
      WaitFrame(30)
      ColOff("wall_cl_8000")
      local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0051")
      local pos = Field.ObjectGetPosition(FLD_OBJ_LOCATOR, index)
      local rot = Field.ObjectGetRotationY(FLD_OBJ_LOCATOR, index)
      Field.PlayEffectScript("ef_f_mov_500_el", pos.x, pos.y, pos.z, rot, 1)
      WaitFrame(30)
      PlaySE(300210, 100)
      WaitFrame(30)
      SetFollowerCameraOperateRotation(5, in_degree_y, 0)
      local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0050")
      Field.ObjectPlayMotionAndSetting(FLD_OBJ_LOCATOR, index, "e001", 5, 0, 0, 60, 1, false)
      PlaySE(201005, 100)
      WaitFrame(60)
      Cam.Inst:Clear(30)
    end
    Field_InvisibleFollowerAllPartyMember(0, 15, false)
    Field_InvisibleFollowerAllGuest(0, 15, false)
    WaitFrame(5)
    ColOff(col1)
    ColOff(col2)
    if point == 3 then
      Field.SetPlayerRotation(in_degree_y, 5)
      Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, in_degree_y, 2.4, in_frame)
      WaitFrame(in_frame - 15)
      Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
      ColOn(col1)
      ColOn(col2)
      tlk:EndTalk()
      MapChange("d", 502, "start_00", true, 0, 15)
    else
      Field.SetPlayerRotation(in_degree_y, 5)
      Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, in_degree_y, 2.4, in_frame)
      WaitFrame(in_frame)
      Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
      ColOn(col1)
      ColOn(col2)
      tlk:EndTalk()
    end
  elseif Item.GetNum(TICKET) >= 1 then
    local tlk = Tlk:new("d05", 1, false)
    tlk:StartTalk()
    local resul = 0
    if point == 1 then
      tlk:Message("f_d0501_0230_0010")
      tlk:Message("f_d0501_0230_0020")
      result = tlk:Select(2, "f_d0501_0230_0030")
    elseif point == 2 then
      tlk:Message("f_d0501_0230_0012")
      tlk:Message("f_d0501_0230_0020")
      result = tlk:Select(2, "f_d0501_0230_0040")
    elseif point == 3 then
      tlk:Message("f_d0501_0230_0014")
      tlk:Message("f_d0501_0230_0020")
      result = tlk:Select(2, "f_d0501_0230_0040")
    end
    if result == RESULT_TALK00 then
      INFO_RELEASE_ITEM(TICKET, 1)
      if point == 1 then
        tlk:Message("f_d0501_0230_0050")
        ColOff(col1)
        ColOff(col2)
        Field.SetPlayerRotation(in_degree_y, 5)
        Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, in_degree_y, 2.4, in_frame)
        WaitFrame(in_frame)
        Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
        ColOn(col1)
        ColOn(col2)
        tlk:EndTalk()
      elseif point == 2 then
        tlk:Message("f_d0501_0220_0032")
        ColOff(col1)
        ColOff(col2)
        Field.SetPlayerRotation(in_degree_y, 5)
        Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, in_degree_y, 2.4, in_frame)
        WaitFrame(in_frame)
        Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
        ColOn(col1)
        ColOn(col2)
        tlk:EndTalk()
      elseif point == 3 then
        tlk:Message("f_d0501_0220_0034")
        tlk:MessageClose()
        Field_InvisibleFollowerAllPartyMember(0, 15, false)
        Field_InvisibleFollowerAllGuest(0, 15, false)
        Cam.Inst:Set(75.422, -44.953, 16.657, 65.73, -42.49, 16.62, default, 30)
        WaitFrame(30)
        ColOff("wall_cl_8000")
        local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0051")
        local pos = Field.ObjectGetPosition(FLD_OBJ_LOCATOR, index)
        local rot = Field.ObjectGetRotationY(FLD_OBJ_LOCATOR, index)
        Field.PlayEffectScript("ef_f_mov_500_el", pos.x, pos.y, pos.z, rot, 1)
        WaitFrame(30)
        PlaySE(300210, 100)
        WaitFrame(30)
        SetFollowerCameraOperateRotation(5, in_degree_y, 0)
        local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0050")
        Field.ObjectPlayMotionAndSetting(FLD_OBJ_LOCATOR, index, "e001", 5, 0, 0, 60, 1, false)
        PlaySE(201005, 100)
        WaitFrame(60)
        Cam.Inst:Clear(30)
        Field.SetPlayerRotation(in_degree_y, 5)
        Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, in_degree_y, 2.4, in_frame)
        WaitFrame(in_frame - 15)
        Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
        ColOn(col1)
        ColOn(col2)
        tlk:EndTalk()
        MapChange("d", 502, "start_00", true, 0, 15)
      end
    elseif result == RESULT_TALK01 and (point == 1 or point == 2) then
      WaitFrame(5)
      ColOff(col1)
      ColOff(col2)
      Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, return_degree_y, 2.8, return_frame)
      WaitFrame(return_frame + 20)
      Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
      ColOn(col1)
      ColOn(col2)
    end
  else
    local tlk = Tlk:new("d05", 1, false)
    tlk:StartTalk()
    if point == 1 then
      tlk:Message("f_d0501_0240_0010")
      Field.ObjectLoadMotion(NPC, GetIndex(NPC, "npc_0652"), "ba02")
      Cam.Inst:Set(-11.852, -19.972, 67.427, -17.959, -19.229, 75.312, default, 15)
      WaitFrame(15)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, GetIndex(NPC, "npc_0652"), "ba02", 10, 10)
      tlk:Message("f_d0501_0240_0020")
      Cam.Inst:Clear(30)
      WaitFrame(15)
      ColOff(col1)
      ColOff(col2)
      Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, return_degree_y, 2.8, return_frame)
      WaitFrame(return_frame + 20)
      Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
      ColOn(col1)
      ColOn(col2)
      tlk:EndTalk()
    elseif point == 2 then
      tlk:Message("f_d0501_0240_0012")
      ColOff(col1)
      ColOff(col2)
      Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, return_degree_y, 2.8, return_frame)
      WaitFrame(return_frame + 20)
      Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
      ColOn(col1)
      ColOn(col2)
      tlk:EndTalk()
    elseif point == 3 then
      tlk:Message("f_d0501_0240_0014")
      tlk:EndTalk()
    end
  end
  Field_CancelInvisibleFollowerAllPartyMember(0, 20, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 20, false, false)
end

function Prcs_d05_ParkGate_Out(degree_y, frame, point, col1, col2)
  ColOff(col1)
  ColOff(col2)
  local tlk = Tlk:new("d05", 1, false)
  tlk:StartTalk()
  if point == 1 then
    tlk:Message("f_d0501_0250_0010")
    tlk:EndTalk()
  elseif point == 2 then
    tlk:Message("f_d0501_0250_0010")
    tlk:EndTalk()
  elseif point == 3 then
    tlk:Message("f_d0501_0250_0010")
    tlk:EndTalk()
    Field_InvisibleFollowerAllPartyMember(0, 15, false)
    Field_InvisibleFollowerAllGuest(0, 15, false)
    SetFollowerCameraOperateRotation(5, degree_y, 30)
    ColOff("wall_cl_8000")
    PlaySE(300210, 100)
    WaitFrame(30)
    local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0050")
    Field.ObjectPlayMotionAndSetting(FLD_OBJ_LOCATOR, index, "e001", 5, 0, 0, 60, 1, false)
    PlaySE(201005, 100)
    WaitFrame(60)
  end
  Field_InvisibleFollowerAllPartyMember(0, 15, false)
  Field_InvisibleFollowerAllGuest(0, 15, false)
  WaitFrame(5)
  Field.ObjectFrameMove2D(FLD_OBJ_PLAYER, 1, degree_y, 2.8, frame)
  WaitFrame(frame + 20)
  Field.ObjectStartMoveMotion(FLD_OBJ_PLAYER, 1, 5)
  ColOn(col1)
  ColOn(col2)
  if point == 3 then
    PlaySE(300210, 100)
    WaitFrame(30)
    local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0050")
    Field.ObjectPlayMotionAndSetting(FLD_OBJ_LOCATOR, index, "e001", 5, 60, 60, 0, 1, false)
    PlaySE(201005, 100)
    WaitFrame(60)
    ColOn("wall_cl_8000")
  end
  Field_CancelInvisibleFollowerAllPartyMember(0, 20, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 20, false, false)
  Field.FollowerWarp()
end

function Prcs_d05_TicketCheck_Gate(paymentflag, col_name)
end

function Prcs_d05_TicketCheck_GuideNPC()
  local FREEPASS = 733
  local TICKET = 732
  if Item.GetNum(FREEPASS) >= 1 then
    return 1
  elseif Item.GetNum(TICKET) >= 1 then
    return 2
  else
    return 3
  end
end

function Prcs_d0502_MoveCranePark_01()
  SetControlScriptExternalVariable("chr609_Crane01_state", "turn")
  Field_InvisibleFollowerAllPartyMember(0, 10, false)
  Field_InvisibleFollowerAllGuest(0, 10, false)
  Cam.Inst:Set(15.91, 7.46, 83.1, 7.85, 11.94, 86.96, default, 30)
  WaitFrame(10)
  local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0001")
  local pos = Field.ObjectGetPosition(FLD_OBJ_LOCATOR, index)
  local rot = Field.ObjectGetRotationY(FLD_OBJ_LOCATOR, index)
  Field.PlayEffectScript("ef_f_mov_500_el", pos.x, pos.y, pos.z, rot, 1)
  WaitFrame(30)
  PlaySE(300210, 100)
  WaitFrame(30)
  Prcs_d05_MoveCrane("gim_0001", "e002", "obj_0001", "e002", "wall_cl_1000", "wall_cl_1001")
  Prcs_d05_MoveCrane("gim_0001", "e001", "obj_0001", "e001", "wall_cl_1001", "wall_cl_1000")
  Cam.Inst:Clear(30)
  WaitFrame(30)
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
end

function Prcs_d0502_MoveCranePark_02()
  Field_InvisibleFollowerAllPartyMember(0, 10, false)
  Field_InvisibleFollowerAllGuest(0, 10, false)
  Cam.Inst:Set(27, 2.2, -39.3, 32.6, 9.3, -35, default, 30)
  WaitFrame(10)
  local index = GetIndex(FLD_OBJ_LOCATOR, "gim_0002")
  local pos = Field.ObjectGetPosition(FLD_OBJ_LOCATOR, index)
  local rot = Field.ObjectGetRotationY(FLD_OBJ_LOCATOR, index)
  Field.PlayEffectScript("ef_f_mov_500_el", pos.x, pos.y, pos.z, rot, 1)
  WaitFrame(30)
  PlaySE(300210, 100)
  WaitFrame(30)
  Prcs_d05_MoveCrane("gim_0002", "e001", "obj_0002", "e002", "wall_cl_1003", "wall_cl_1002")
  Prcs_d05_MoveCrane("gim_0002", "e002", "obj_0002", "e001", "wall_cl_1002", "wall_cl_1003")
  Cam.Inst:Clear(30)
  WaitFrame(30)
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
end

function Prcs_d0502_M150Event_180BA()
  Fade_OutNoLoadingWithWait(FADE_BLACK, FADE_TIME)
  FieldObjectSync(FOR_ALL, true)
  WaitFrame(20)
  M150:Event_180BA()
end

function Prcs_d05FollowerWarp()
  Field.FollowerWarp()
end

function Prcs_d05_ArenaWarpIn(gim_name)
  Field.CancelPlayerAnywhereDigimonRide(false)
  Field_InvisibleFollowerAllGuest(0, 10, false)
  Field_InvisibleFollowerAllPartyMember(0, 10, false)
  Flg.Set("FLAG_FIELD_D05_ARENAWARP")
  local obj_index = GetIndex(OGIM, gim_name)
  local obj_pos = Field.ObjectGetPosition(OGIM, obj_index)
  Field.ObjectFrameMoveToTarget2D(FLD_OBJ_PLAYER, 1, obj_pos.x, obj_pos.z, 2, 20)
  WaitFrame(30)
  local player_pos = Field.ObjectGetPosition(FLD_OBJ_PLAYER, 1)
  PlayEffectScript("ef_f_mov_111_wa", player_pos.x, player_pos.y + 1, player_pos.z, 0, 1)
  PlaySE(200006, 100)
  WaitFrame(20)
  Obj:new(PLAYER, ""):Invisible(5)
  WaitFrame(10)
end

function Prcs_d05_ArenaWarpOut()
  Flg.Clear("FLAG_FIELD_D05_ARENAWARP")
  Field_InvisibleFollowerAllGuest(0, 0, false)
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  local player_pos = Field.ObjectGetPosition(FLD_OBJ_PLAYER, 1)
  Obj:new(PLAYER, ""):Invisible(0)
  WaitFrame(3)
  FadeInWithWait(0, 15)
  WaitFrame(15)
  PlayEffectScript("ef_f_mov_111_wa", player_pos.x, player_pos.y + 1, player_pos.z, 0, 1)
  PlaySE(200006, 100)
  WaitFrame(15)
  Obj:new(PLAYER, ""):CancelInvisible(15)
  WaitFrame(30)
  Field_CancelInvisibleFollowerAllGuest(0, 10, false, false)
  Field_CancelInvisibleFollowerAllPartyMember(0, 10, false, false)
end

function Prcs_d0506_ArenaAppearMarusumonEvent()
  if Flg.Check("FLAG_FREEARENA_RELEASE_018", "FLAG_FREEARENA_APPEARMARUSMON01") then
    Fade_OutNoLoadingWithWait(FADE_BLACK, 0)
    local npc_0001 = GetIndex(NPC, "npc_0001")
    local pos = Field.GetLocatorPosition("start_02")
    local player_pos = Field.ObjectGetPosition(FLD_OBJ_PLAYER, 1)
    local npc_pos = Field.ObjectGetPosition(NPC, npc_0001)
    Field.ObjectSetPos(PLAYER, 1, pos.x, pos.y, pos.z)
    local obj1_to_obj2_rot = Field.GetAngleToTarget2D(player_pos.x, player_pos.z, npc_pos.x, npc_pos.z)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, obj1_to_obj2_rot, 0)
    PlayerLookAtObject(NPC, "npc_0001")
    Flg.Set("FLAG_FREEARENA_APPEARMARUSMON01")
    Flg.Set("FLAG_FREEARENA_GREETINGSKIP_01")
    Field.ObjectLoadMotion(NPC, npc_0001, "fe02")
    Field.ObjectLoadMotion(NPC, npc_0001, "fe04")
    Field.ObjectLoadMotion(NPC, npc_0001, "fq01")
    Field.ObjectLoadMotion(NPC, npc_0001, "bn01")
    Field.ObjectLoadMotion(NPC, npc_0001, "bv01")
    Cam.Inst:Set(-13.608, 1.836, 80.174, -4.906, 1.322, 85.073, default, 0)
    SetFollowerCameraOperateRotation(0, -30, 0)
    local tlk = Tlk:new("d05", 1, false)
    tlk:StartTalk()
    WaitFrame(15)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    WaitFrame(15)
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fe02", 10, 10)
    tlk:Message("f_d0506_0210_0010")
    tlk:Message("f_d0506_0210_0020")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "bv01", 10, 10)
    tlk:Message("f_d0506_0210_0030")
    tlk:Message("f_d0506_0210_0040")
    tlk:Message("f_d0506_0210_0050")
    tlk:Message("f_d0506_0210_0060")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fe04", 10, 10)
    tlk:Message("f_d0506_0210_0070")
    tlk:EndTalk()
    Cam.Inst:Clear(30)
  end
end

function Prcs_d0513_ArenaWinMarusumonEvent()
  if Flg.Check("FLAG_FREEARENA_WIN_018", "FLAG_FREEARENA_WINARMARUSMON01") then
    local npc_0001 = GetIndex(NPC, "npc_0001")
    local pos = Field.GetLocatorPosition("start_02")
    local player_pos = Field.ObjectGetPosition(FLD_OBJ_PLAYER, 1)
    local npc_pos = Field.ObjectGetPosition(NPC, npc_0001)
    Field.ObjectSetPos(PLAYER, 1, pos.x, pos.y, pos.z)
    local obj1_to_obj2_rot = Field.GetAngleToTarget2D(player_pos.x, player_pos.z, npc_pos.x, npc_pos.z)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, obj1_to_obj2_rot, 0)
    PlayerLookAtObject(NPC, "npc_0001")
    Flg.Set("FLAG_FREEARENA_WINARMARUSMON01")
    Flg.Set("FLAG_FREEARENA_GREETINGSKIP_01")
    Field.ObjectLoadMotion(NPC, npc_0001, "fe02")
    Field.ObjectLoadMotion(NPC, npc_0001, "fe04")
    Field.ObjectLoadMotion(NPC, npc_0001, "fq01")
    Field.ObjectLoadMotion(NPC, npc_0001, "bn01")
    Field.ObjectLoadMotion(NPC, npc_0001, "bv01")
    Cam.Inst:Set(-13.608, 1.836, 80.174, -4.906, 1.322, 85.073, default, 0)
    SetFollowerCameraOperateRotation(0, -30, 0)
    local tlk = Tlk:new("d05", 1, false)
    tlk:StartTalk()
    WaitFrame(15)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    WaitFrame(15)
    Field.ObjectPlayMotion(NPC, npc_0001, "fq01", 10, true)
    tlk:Message("f_d0506_0220_0010")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fe02", 10, 10)
    tlk:Message("f_d0506_0220_0020")
    Field.ObjectPlayMotion(NPC, npc_0001, "fq01", 10, true)
    tlk:Message("f_d0506_0220_0030")
    tlk:Message("f_d0506_0220_0040")
    tlk:Message("f_d0506_0220_0050")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fe04", 10, 10)
    tlk:Message("f_d0506_0220_0060")
    tlk:Message("f_d0506_0220_0070")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "bv01", 10, 10)
    tlk:Message("f_d0506_0220_0080")
    tlk:EndTalk()
    require("Sarena_300")
    Sarena_300:GreatestOmegaCarnival_End()
    Cam.Inst:Clear(30)
  end
end

function Prcs_d0513_RingEvent0001()
  if Flg.Check("FLAG_MAIN_12_055") then
    local wincount = ArenaCheckWin()
    local npc_0001 = GetIndex(NPC, "npc0001")
    Field.ObjectLoadMotion(NPC, npc_0001, "bn01")
    Field.ObjectLoadMotion(NPC, npc_0001, "e002")
    Field.ObjectLoadMotion(NPC, npc_0001, "e004")
    Field.ObjectLoadMotion(NPC, npc_0001, "e005")
    Field.ObjectLoadMotion(NPC, npc_0001, "e007")
    Field.ObjectLoadMotion(NPC, npc_0001, "e008")
    Field.ObjectLoadMotion(NPC, npc_0001, "e012")
    Field.ObjectLoadMotion(NPC, npc_0001, "e013")
    Field.ObjectLoadMotion(NPC, npc_0001, "fe04")
    Field.ObjectLoadMotion(NPC, npc_0001, "fq01")
    Field.ObjectLoadMotion(NPC, npc_0001, "fq02")
    local player_e002_01 = Motion.Object:new(PLAYER, "", "e002_01")
    local player_e004 = Motion.Object:new(PLAYER, "", "e004")
    Cam.Inst:Set(-9.88, 21.33, 128.1, -10.87, 23.41, 137.83, default, 0)
    WaitFrame(5)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    WaitFrame(30)
    if Flg.Check("FLAG_FREEARENA_WIN_018") then
      local tlk = Tlk:new("d05", 1, false)
      tlk:StartTalk()
      Field.ObjectLookAtTheObject(NPC, npc_0001, PLAYER, 1, 30)
      Field.ObjectLookAtTheObject(PLAYER, 1, NPC, npc_0001, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e013", 10, 10)
      tlk:Message("f_d0513_0070_0010")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e002", 10, 10)
      tlk:Message("f_d0513_0070_0020")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fq02", 10, 10)
      tlk:Message("f_d0513_0070_0030")
      tlk:Message("f_d0513_0070_0040")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e012", 10, 10)
      tlk:Message("f_d0513_0070_0050")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e007", 10, 10)
      tlk:Message("f_d0513_0070_0060")
      tlk:MessageClose()
      player_e004:Play(5, false)
      WaitFrame(30)
      tlk:EndTalk()
    elseif Flg.Check("FLAG_FREEARENA_RELEASE_018") then
      local tlk = Tlk:new("d05", 1, false)
      tlk:StartTalk()
      Field.ObjectLookAtTheObject(PLAYER, 1, NPC, npc_0001, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fq01", 10, 10)
      tlk:Message("f_d0513_0060_0010")
      tlk:Message("f_d0513_0060_0020")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e012", 10, 10)
      tlk:Message("f_d0513_0060_0030")
      tlk:Message("f_d0513_0060_0040")
      Field.ObjectLookAtTheObject(NPC, npc_0001, PLAYER, 1, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fe04", 10, 10)
      tlk:Message("f_d0513_0060_0050")
      tlk:MessageClose()
      player_e004:Play(5, false)
      WaitFrame(30)
      tlk:EndTalk()
    elseif 15 <= wincount then
      local tlk = Tlk:new("d05", 1, false)
      tlk:StartTalk()
      Field.ObjectLookAtTheObject(NPC, npc_0001, PLAYER, 1, 30)
      Field.ObjectLookAtTheObject(PLAYER, 1, NPC, npc_0001, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e002", 10, 10)
      tlk:Message("f_d0513_0050_0010")
      tlk:Message("f_d0513_0050_0020")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fq01", 10, 10)
      tlk:Message("f_d0513_0050_0030")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e008", 10, 10)
      tlk:Message("f_d0513_0050_0040")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e007", 10, 10)
      tlk:Message("f_d0513_0050_0050")
      tlk:MessageClose()
      player_e004:Play(5, false)
      WaitFrame(30)
      tlk:EndTalk()
    elseif 10 <= wincount and wincount < 15 then
      local tlk = Tlk:new("d05", 1, false)
      tlk:StartTalk()
      Field.ObjectLookAtTheObject(NPC, npc_0001, PLAYER, 1, 30)
      Field.ObjectLookAtTheObject(PLAYER, 1, NPC, npc_0001, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e002", 10, 10)
      tlk:Message("f_d0513_0040_0010")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e008", 10, 10)
      tlk:Message("f_d0513_0040_0020")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e004", 10, 10)
      tlk:Message("f_d0513_0040_0030")
      tlk:MessageClose()
      player_e004:Play(5, false)
      WaitFrame(30)
      tlk:EndTalk()
    elseif 5 <= wincount and wincount < 10 then
      local tlk = Tlk:new("d05", 1, false)
      tlk:StartTalk()
      Field.ObjectLookAtTheObject(NPC, npc_0001, PLAYER, 1, 30)
      Field.ObjectLookAtTheObject(PLAYER, 1, NPC, npc_0001, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e002", 10, 10)
      tlk:Message("f_d0513_0030_0010")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fq01", 10, 10)
      tlk:Message("f_d0513_0030_0020")
      tlk:Message("f_d0513_0030_0030")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e004", 10, 10)
      tlk:Message("f_d0513_0030_0040")
      tlk:MessageClose()
      player_e004:Play(5, false)
      WaitFrame(30)
      tlk:EndTalk()
    elseif Flg.Check("FLAG_FREEARENA_FIRSTTALK_01") then
      local tlk = Tlk:new("d05", 1, false)
      tlk:StartTalk()
      Field.ObjectLookAtTheObject(NPC, npc_0001, PLAYER, 1, 30)
      Field.ObjectLookAtTheObject(PLAYER, 1, NPC, npc_0001, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e007", 10, 10)
      tlk:Message("f_d0513_0020_0010")
      tlk:MessageClose()
      player_e002_01:Play2Wait(10, false)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fq01", 10, 10)
      tlk:Message("f_d0513_0020_0020")
      tlk:Message("f_d0513_0020_0030")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fe04", 10, 10)
      tlk:Message("f_d0513_0020_0040")
      tlk:Message("f_d0513_0020_0050")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e004", 10, 10)
      tlk:Message("f_d0513_0020_0060")
      tlk:MessageClose()
      player_e004:Play(5, false)
      WaitFrame(30)
      tlk:EndTalk()
    else
      local tlk = Tlk:new("d05", 1, false)
      tlk:StartTalk()
      Field.ObjectPlayMotion(NPC, npc_0001, "e013", 10, true)
      tlk:Message("f_d0513_0010_0010")
      tlk:Message("f_d0513_0010_0020")
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "fq02", 10, 10)
      tlk:Message("f_d0513_0010_0030")
      Field.ObjectPlayMotion(NPC, npc_0001, "e012", 10, true)
      tlk:Message("f_d0513_0010_0040")
      Field.ObjectLookAtTheObject(NPC, npc_0001, PLAYER, 1, 30)
      Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0001, "e007", 10, 10)
      tlk:Message("f_d0513_0010_0050")
      tlk:MessageClose()
      player_e004:Play(5, false)
      WaitFrame(30)
      tlk:EndTalk()
    end
    Flg.Clear("FLAG_FIELD_D05_ARENARINGEVENT")
    MapChange("d", 506, "start_01", true, FADE_BLACK, FADE_TIME)
  end
end
