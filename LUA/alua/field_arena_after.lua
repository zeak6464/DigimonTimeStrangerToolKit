require("define")
require("function_common")
require("function_field")
require("function_event")
require("function_sound")
require("chapter")

function Arena_After_Battle_001()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_001_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_002()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_002_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_003()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_003_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_004()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_004_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_005()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_005_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_006()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_006_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_007()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_007_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_008()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_008_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_009()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_009_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_010()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_010_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_011()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_011_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_012()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_012_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_013()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_013_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_014()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_014_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_015()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_015_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_016()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_016_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_017()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_017_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_018()
  HideMinimap(true)
  HideGuide(true)
  if Flg.Check("FLAG_FREEARENA_WIN_018", "FLAG_FREEARENA_WINARMARUSMON02") then
    Flg.Set("FLAG_FREEARENA_WINARMARUSMON02")
    Arena_WinMarusmonEventOnce()
  else
    local tlk = Tlk:new("arena01", 1, true, false)
    tlk:StartTalk()
    Arena_WinEvent()
    tlk:Message("arena01_f001_018_060")
    tlk:EndTalk()
  end
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_019()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_019_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_020()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_020_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_021()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_021_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_022()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_022_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_After_Battle_023()
  HideMinimap(true)
  HideGuide(true)
  local tlk = Tlk:new("arena01", 1, true, false)
  tlk:StartTalk()
  Arena_WinEvent()
  tlk:Message("arena01_f001_023_060")
  tlk:EndTalk()
  Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
  MapChange("d", 506, "start_03", true, FADE_BLACK, FADE_TIME)
end

function Arena_WinMarusmonEventOnce()
  Digimon.RestoreAllParty()
  local npc_0009 = GetIndex(NPC, "npc0009")
  Field.ObjectLoadMotion(NPC, npc_0009, "bn01")
  Field.ObjectLoadMotion(NPC, npc_0009, "e002")
  Field.ObjectLoadMotion(NPC, npc_0009, "e004")
  Field.ObjectLoadMotion(NPC, npc_0009, "e005")
  Field.ObjectLoadMotion(NPC, npc_0009, "e007")
  Field.ObjectLoadMotion(NPC, npc_0009, "e008")
  Field.ObjectLoadMotion(NPC, npc_0009, "e012")
  Field.ObjectLoadMotion(NPC, npc_0009, "e013")
  Field.ObjectLoadMotion(NPC, npc_0009, "fe04")
  Field.ObjectLoadMotion(NPC, npc_0009, "fq01")
  Field.ObjectLoadMotion(NPC, npc_0009, "fq02")
  local player_e002_01 = Motion.Object:new(PLAYER, "", "e002_01")
  local player_e004 = Motion.Object:new(PLAYER, "", "e004")
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Field_InvisibleFollowerAllGuest(0, 0, false)
  InvisibleNpcInArena()
  Cam.Inst:Set(3.978, 2.271, 0.018, -5.926, 1.015, 0.573, default, 0)
  Obj:new(PLAYER, ""):SetPos(0, 0.001, -1.777, true)
  Obj:new(PLAYER, ""):SetRotationY(180, 0)
  Obj:new(NPC, "npc0009"):CancelInvisible()
  PlayerLookAtObject(NPC, "npc0009")
  WaitFrame(15)
  Field.ObjectLookAtTheObject(NPC, npc_0009, PLAYER, 1, 30)
  Field.ObjectLookAtTheObject(PLAYER, 1, NPC, npc_0009, 30)
  FadeAllInWithWait(FADE_WHITE, FADE_TIME)
  WaitFrame(15)
  local tlk = Tlk:new("d05", 1, true, false)
  tlk:StartTalk()
  tlk:Message("f_d0513_0080_0010")
  Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0009, "e002", 10, 10)
  tlk:Message("f_d0513_0080_0020")
  tlk:Message("f_d0513_0080_0030")
  Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0009, "fq01", 10, 10)
  tlk:Message("f_d0513_0080_0040")
  Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_0009, "e007", 10, 10)
  tlk:Message("f_d0513_0080_0050")
  tlk:MessageClose()
  player_e004:Play(5, false)
  WaitFrame(30)
  tlk:EndTalk()
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Field_InvisibleFollowerAllGuest(0, 0, false)
end

function Arena_WinEvent()
  Digimon.RestoreAllParty()
  Cam.Inst:Set(1.342, -0.449, -16.806, -0.498, 1.556, -7.184, default, 0)
  InvisibleNpcInArena()
  Obj:new(PLAYER, ""):SetPos(0, -0.001, -10, true)
  Obj:new(PLAYER, ""):SetRotationY(180, 0)
  Field.ObjectLoadMotion(PLAYER, 1, "e004")
  FollowerSync()
  WaitFrame(5)
  Field.FollowerWarp()
  WaitFrame(5)
  SetHeroine("e004_01", -0.875, 0, -10.682, 180)
  SetAegio("e004", 0.799, 0, -10.753, 180)
  SetPartyMember("ba01", 0.974, -0.001, -13.342, 180, 1)
  SetPartyMember("ba01", 3.516, 0, -13.035, 180, 2)
  SetPartyMember("ba01", -1.649, 0, -13.176, 180, 3)
  FadeAllInWithWait(FADE_WHITE, FADE_TIME)
  WaitFrame(15)
  Field.ObjectPlayMotion(PLAYER, 1, "e004", 5, true)
  PlayHeroineMotion("e004_01")
  PlayAegioMotion("e004")
  PlayPartyMemberMotion("ba01", 1)
  PlayPartyMemberMotion("ba01", 2)
  PlayPartyMemberMotion("ba01", 3)
end

function SetHeroine(motion_name, posx, posy, posz, rot)
  local heroine = Field.GetFollowerIndexByGuestID(GST_HEROINE)
  if heroine ~= nil then
    Field.ObjectLoadMotion(FLD_OBJ_FOLLOWER, heroine, motion_name)
    Field.ObjectCancelInvisible(FLD_OBJ_FOLLOWER, heroine, 0, 0, true)
    Field.ObjectSetRotationY(FLD_OBJ_FOLLOWER, heroine, rot, 0)
    Field.ObjectSetPos(FLD_OBJ_FOLLOWER, heroine, posx, posy, posz, true)
  end
end

function PlayHeroineMotion(motion_name)
  local heroine = Field.GetFollowerIndexByGuestID(GST_HEROINE)
  if heroine ~= nil then
    Field.ObjectPlayMotion(FLD_OBJ_FOLLOWER, heroine, motion_name, 5, true)
  end
end

function SetAegio(motion_name, posx, posy, posz, rot)
  local aegio = Field.GetFollowerIndexForAegiomon()
  if aegio ~= nil then
    Field.ObjectLoadMotion(FLD_OBJ_FOLLOWER, aegio, motion_name)
    Field.ObjectCancelInvisible(FLD_OBJ_FOLLOWER, aegio, 0, 0, true)
    Field.ObjectSetRotationY(FLD_OBJ_FOLLOWER, aegio, rot, 0)
    Field.ObjectSetPos(FLD_OBJ_FOLLOWER, aegio, posx, posy, posz, true)
  end
end

function PlayAegioMotion(motion_name)
  local aegio = Field.GetFollowerIndexForAegiomon()
  if aegio ~= nil then
    Field.ObjectPlayMotion(FLD_OBJ_FOLLOWER, aegio, motion_name, 5, true)
  end
end

function SetPartyMember(motion_name, posx, posy, posz, rot, partypos)
  local index = Digimon.GetUniqueIDInPartyMember(partypos)
  if index ~= nil then
    local party = Field.GetFollowerIndexByPartyUniqueID(index)
    Field.ObjectCancelInvisible(FLD_OBJ_FOLLOWER, party, 0, 0, true)
    Field.ObjectLoadMotion(FLD_OBJ_FOLLOWER, party, motion_name)
    Field.ObjectSetRotationY(FLD_OBJ_FOLLOWER, party, rot, 0)
    Field.ObjectSetPos(FLD_OBJ_FOLLOWER, party, posx, posy, posz, true)
  end
end

function PlayPartyMemberMotion(motion_name, partypos)
  local index = Digimon.GetUniqueIDInPartyMember(partypos)
  if party ~= nil then
    local party = Field.GetFollowerIndexByPartyUniqueID(index)
    Field.ObjectPlayMotionWithStartMoveMotion(FLD_OBJ_FOLLOWER, party, motion_name, 5, 10)
  end
end
