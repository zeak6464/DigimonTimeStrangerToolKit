gGimText = "field_text"

function Prcs_d1001_Breaker()
  if not Flg.Check("FLAG_MAIN_01_150") then
    M020:Event_070()
  else
    Field_Talk_Start_Not_LetterBox(gGimText, 1)
    Message("g_d1001_0030_0010")
    Field_Talk_End_Not_LetterBox()
  end
end

function Prcs_d1001_HideToHole()
  ColOff("plan_cl_1004")
  Cam.Inst:Set(-10.1, -4.2, 44.2, -9.5, -0.5, 35, default, 0)
  SetPlayerStealthFromSymbolEnemy(true)
  Field_InvisibleFollowerAllPartyMember(0, 20, false)
  Field_InvisibleFollowerAllGuest(0, 20, false)
  WaitFrame(3)
  Field.PlayerChangeMoveAnimationWithBlend("hide", 6, 2.5)
  WaitFrame(6)
  Field.MovePlayerToLocatorFrame("sp_0001", 15)
  Fade.Out(0, Util.SecondFromFrame(12))
  WaitFrame(15)
  SetPlayerLocator("sp_0001")
  Cam.Inst:Set(-10.4, 1, 32.7, -9, -3.3, 43.9, default, 0)
  ColOn("plan_cl_1004")
  Fade.In(0, Util.SecondFromFrame(10))
  WaitFrame(10)
  Flg.Set("FLAG_GIMMICK_D10_070")
end

function Prcs_d1001_CanselHideToHole()
  ColOff("plan_cl_1004")
  Fade.Out(0, Util.SecondFromFrame(12))
  Field.MovePlayerToLocatorFrame("sp_0003", 10)
  Field_CancelInvisibleFollowerAllPartyMember(0, 20, false, false)
  Field_CancelInvisibleFollowerAllGuest(0, 20, false, false)
  WaitFrame(15)
  ColOn("plan_cl_1004")
  SetPlayerLocator("sp_0002")
  SetFollowerCameraOperateRotation(0, 10)
  Cam.Inst:Clear(0)
  WaitFrame(2.5)
  Fade.In(0, Util.SecondFromFrame(12))
  Field.PlayerResetMoveAnimationWithBlend(10)
  WaitFrame(10)
  SetPlayerStealthFromSymbolEnemy(false)
  Flg.Clear("FLAG_GIMMICK_D10_070")
end

function Prcs_d1001_OpenGrateDoor()
  local tlk = Tlk:new("d10", 1, true)
  tlk:StartTalk()
  tlk:Message("f_d1001_0130_0010")
  tlk:EndTalk()
  M020:Event_050()
end

function Prcs_d1001_CatchedGreymon()
  local state = GetControlScriptExternalVariableString("mgreymon_state")
  Flg.Clear("FLAG_FIELD_D10_012")
  Flg.Clear("FLAG_FIELD_D10_013")
  local index = Field.GetSymbolEnemyIndex("chr327_chaser")
  Field.ObjectFrameMove2D(FLD_OBJ_SYMBOL_ENEMY, index, 270, 8, 30)
  Field.SetEnablePlayerIgnoreWorld(true)
  Motion.Player:Play("bl01", 5, false)
  WaitFrame(20)
  BackFade_OutNoLoading(FADE_BLACK, FADE_TIME)
  WaitFrame(15)
  Flg.Clear("FLAG_FIELD_D10_013")
  Motion.Player:ResetMoveAnim()
  Field.SetEnablePlayerIgnoreWorld(false)
  SetControlScriptExternalVariable("mgreymon_state", "standby")
  if state == "start" then
    SetPlayerLocator("start_51")
    SetPlayerRotationByLocator("sp_0004", 0)
    local pos = Field.GetLocatorPosition("script_relocation3")
    Field.ObjectSetPos(FLD_OBJ_SYMBOL_ENEMY, index, pos.x, pos.y, pos.z)
    SetFollowerCameraOperateRotation(-15, 90)
    Field.CameraZoomFrame(1, -0.5, 0, 0)
    SetEnableCameraOperate(false)
    SetControlScriptExternalVariable("mgreymon_state", "start")
    Field.FollowerWarp()
    Flg.Set("FLAG_FIELD_D10_012")
    Flg.Set("FLAG_FIELD_D10_013")
    Field_Talk_Start("d10", 1)
    Message("f_d1001_0070_0010")
    Field_Talk_End()
    Field_InvisibleFollowerAllPartyMember(0, 0, false)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    BackFade_In(FADE_BLACK, FADE_TIME)
    WaitFrame(15)
    local index = Field.GetSymbolEnemyIndex("chr327_chaser")
    Field.ObjectFrameMove2D(FLD_OBJ_SYMBOL_ENEMY, index, 270, 8, 30)
  end
  if state == "roaming2" then
    local pos = Field.GetLocatorPosition("script_relocation2")
    Field.ObjectSetPos(FLD_OBJ_SYMBOL_ENEMY, index, pos.x, pos.y, pos.z)
    SetPlayerLocator("sp_0007")
    SetControlScriptExternalVariable("mgreymon_state", "roaming2")
    Field.FollowerWarp()
    Field_Talk_Start("d10", 1)
    Message("f_d1001_0040_0010")
    Field_Talk_End()
    Field_InvisibleFollowerAllPartyMember(0, 0, false)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    BackFade_In(FADE_BLACK, FADE_TIME)
    WaitFrame(15)
  end
  if state == "roaming3" then
    local pos = Field.GetLocatorPosition("script_relocation4")
    Field.ObjectSetPos(FLD_OBJ_SYMBOL_ENEMY, index, pos.x, pos.y, pos.z)
    SetPlayerLocator("sp_0008")
    SetControlScriptExternalVariable("mgreymon_state", "roaming3")
    Field.FollowerWarp()
    Field_Talk_Start("d10", 1)
    Message("f_d1001_0070_0010")
    Field_Talk_End()
    Field_InvisibleFollowerAllPartyMember(0, 0, false)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    BackFade_In(FADE_BLACK, FADE_TIME)
    WaitFrame(15)
  end
  if state == "roaming4" then
    local pos = Field.GetLocatorPosition("script_relocation3")
    Field.ObjectSetPos(FLD_OBJ_SYMBOL_ENEMY, index, pos.x, pos.y, pos.z)
    SetPlayerLocator("sp_0009")
    SetControlScriptExternalVariable("mgreymon_state", "roaming4")
    Field.FollowerWarp()
    Field_Talk_Start("d10", 1)
    Message("f_d1001_0070_0010")
    Field_Talk_End()
    Field_InvisibleFollowerAllPartyMember(0, 0, false)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    BackFade_In(FADE_BLACK, FADE_TIME)
    WaitFrame(15)
    Flg.Set("FLAG_FIELD_D10_012")
    local index = Field.GetSymbolEnemyIndex("chr327_chaser")
    Field.ObjectFrameMove2D(FLD_OBJ_SYMBOL_ENEMY, index, 270, 8, 30)
  end
end

function Prcs_d1003_Tutorial()
  SetFollowerCameraOperateRotation(default, 0)
  RegularQuake_Stop()
  Field_InvisibleFollowerAllPartyMember(0, 30, false)
  HideMinimap(true)
  Cam.Inst:Set(42.75, -0.869, -24.38, 44.35, 0.957, -14.68, default, 20)
  CancelTheStealthAtStart()
  SymbolEnemyDiscoveryNumber(1)
  WaitFrame(45)
  Motion.Player:Play("e013", 0, true)
  Cam.Inst:Clear(0)
  CameraSwitchChange("followcam_loc_04_01", false)
  HideMinimap(false)
  CameraSwitchChange("followcam_default_loc1", false)
  Field_CancelInvisibleFollowerAllPartyMember(0, 30, false, false)
  Motion.Player:Play("fn01_01", 0, false)
  RegularQuake_Start(0.02, 0, 60, 120)
end
