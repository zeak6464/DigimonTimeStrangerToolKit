gGimText = "field_text"
M270 = {ID = 270}

function M270:Event_010()
  if Flg.Check("FLAG_MAIN_09_049", "FLAG_MAIN_09_050") then
    Flg.Set("FLAG_MAIN_09_050")
    Flg.Set("FLAG_IS_NOT_MAP_NAME_DISP")
    WaitFrame(30)
    PlayDungeonBGM()
    Execute("m270_010")
    MapChange("t", 3003, "start_00", false, FADE_BLACK, FADE_TIME)
  end
end

function M270:Event_020()
  if Flg.Check("FLAG_MAIN_09_050", "FLAG_MAIN_09_053") then
    Flg.Set("FLAG_MAIN_09_053")
    Execute("m270_020")
    MapChange("t", 3001, "start_02", false, FADE_BLACK, FADE_TIME)
  end
end

function M270:Event_030()
  if Flg.Check("FLAG_MAIN_09_053", "FLAG_MAIN_09_055") then
    WaitFrame(10)
    Flg.Set("FLAG_MAIN_09_055")
    Cam.Inst:Set(-1.357, 0.225, -15.153, 0.841, 1.405, -5.47, default, 0)
    FieldObjectSync(NPC, false)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 340, 0)
    Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, 0.998, 0, -7.221)
    Field_InvisibleFollowerAllGuest(0, 1, false)
    Field_InvisibleFollowerAllPartyMember(0, 1, false)
    Field.HideGuide(true)
    Field.HideMinimap(true)
    WaitFrame(10)
    FadeInWithWaitNotFlgCheck(FADE_BLACK, FADE_TIME)
    local npc_index01 = GetIndex(NPC, "npc_001")
    local mirei_e002 = Motion.Object:new(NPC, "npc_001", "e002")
    local mirei_e003 = Motion.Object:new(NPC, "npc_001", "e003")
    local mirei_e551 = Motion.Object:new(NPC, "npc_001", "e551")
    local aigio_e002 = Motion.Object:new(NPC, "npc_002", "e002")
    local tlk = Tlk:new("t30", 1, true)
    tlk:StartTalkAndCancelDigimonRide()
    mirei_e002:Play(10, true)
    Field.ObjectChangeExpression(NPC, GetIndex(NPC, "npc_001"), "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message("f_t3001_0160_0010")
    Field.ObjectChangeExpression(NPC, GetIndex(NPC, "npc_001"), "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    aigio_e002:Play(10, true)
    tlk:Message("f_t3001_0160_0020")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_index01, "e003", 10, 10)
    Field.ObjectChangeExpression(NPC, GetIndex(NPC, "npc_001"), "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message("f_t3001_0160_0030")
    tlk:Message("f_t3001_0160_0040")
    tlk:Message("f_t3001_0160_0050")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, npc_index01, "e551", 10, 10)
    tlk:Message("f_t3001_0160_0060")
    Field.ObjectChangeExpression(NPC, GetIndex(NPC, "npc_001"), "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    tlk:EndTalk()
    Field_InvisibleFollowerAllGuest(0, 1, false)
    Field_InvisibleFollowerAllPartyMember(0, 1, false)
    Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
    MapChange("t", 3002, "start_00", true, FADE_BLACK, FADE_TIME)
  end
end

function M270:Event_040()
  if Flg.Check("FLAG_MAIN_09_055", "FLAG_MAIN_09_057") then
    WaitFrame(10)
    Cam.Inst:Set(0.13, 1.38, -7.48, -0.01, 2.46, 2.45, default, 0)
    FieldObjectSync(NPC, false)
    Field.HideGuide(true)
    Field.HideMinimap(true)
    Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, 0, 0)
    Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, -0.056, 0.392, -1.539)
    Field_InvisibleFollowerAllGuest(0, 1, false)
    Field_InvisibleFollowerAllPartyMember(0, 1, false)
    WaitFrame(10)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    Flg.Set("FLAG_MAIN_09_057")
    Motion.Player:PlayWithMoveMotion("e050", 5, 5)
    WaitFrame(60)
    Fade_OutNoLoadingWithWait(FADE_WHITE, FADE_TIME)
    WaitFrame(60)
    Execute("m270_040")
    Execute("m270_050")
    MapChange("t", 3001, "start_01", false, FADE_WHITE, FADE_TIME)
  end
end

function M270:Event_050()
  if Flg.Check("FLAG_MAIN_09_057", "FLAG_MAIN_09_058") then
    local heroine = Obj:new(FLD_OBJ_FOLLOWER, GST_HEROINE, "guest")
    local aegio = Field.GetFollowerIndexForAegiomon()
    if Common.GetGameClearNum() < 1 then
      Common.SetAegiomonFriendship(63)
      Common.SetAegiomonGiftPoint(40000)
    end
    Flg.Set("FLAG_MAIN_09_058")
    FieldObjectSync(FOR_ALL, false)
    Obj:new(FLD_OBJ_LOCATOR, "change_0003"):SetEnableCheckAndFieldAttack(true)
    Obj:new(PLAYER, ""):SetPos(1.296, 0, -1.051)
    Obj:new(PLAYER, ""):SetRotationY(210, 0)
    heroine:SetPos(-68.543, 20.843, 22.863, true)
    Field.ObjectSetPos(FLD_OBJ_FOLLOWER, aegio, -67.986, 20.843, 21.538)
    Cam.Inst:Set(-2.929, -0.6, 6.795, 0.863, 1.227, -2.274, default, 0)
    Field.HideGuide(true)
    Field.HideMinimap(true)
    Prcs_t30_InvisibleFollower()
    WaitFrame(1)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    local tlk = Tlk:new("t30", 1, true)
    local mirei_e002 = Motion.Object:new(NPC, "npc_005", "e002")
    tlk:StartTalkAndCancelDigimonRide()
    Field.ObjectChangeExpression(NPC, GetIndex(NPC, "npc_005"), "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message("f_t3001_0150_0010")
    tlk:Message("f_t3001_0150_0020")
    tlk:Message("f_t3001_0150_0030")
    tlk:Message("f_t3001_0150_0040")
    mirei_e002:Play(10, true)
    tlk:Message("f_t3001_0150_0050")
    Field.ObjectResetMotion(NPC, GetIndex(NPC, "npc_005"), 30)
    Fade_OutNoLoadingWithWait(FADE_BLACK, FADE_TIME)
    tlk:EndTalk()
    Flg.Set("FLAG_MAIN_09_059")
    FieldObjectSync(FOR_ALL, false)
    Cam.Inst:Clear(0)
    Field.HideGuide(false)
    Field.HideMinimap(false)
    Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
  end
end
