S100_178 = {
  ID = 178,
  STEP_001 = 1,
  STEP_005 = 5,
  STEP_255 = 255
}
local base = "s100_178_"
local text_file = "s100_178"
local tlk = Tlk:new(text_file, 1, true)

function S100_178:Event_010()
  if Qst.Sub:Check(self.ID, self.STEP_001, self.STEP_255) then
    local mirei_index = GetIndex(NPC, "s100_178_mirei")
    Field.ObjectLoadMotion(NPC, mirei_index, "fn01_01")
    Field.ObjectLoadMotion(NPC, mirei_index, "e002")
    Field.ObjectLoadMotion(NPC, mirei_index, "e550")
    Field.ObjectLoadExpression(NPC, mirei_index, "F01")
    tlk:StartTalkAndCancelDigimonRide()
    HideMinimap(true)
    HideGuide(true)
    Flg.Set("FLAG_SUB_100_178_001")
    Fade_OutNoLoadingWithWait(FADE_BLACK, FADE_TIME)
    Cam.Inst:Set(33.39, 0.25, -13.52, 23.45, 1.38, -13.77, default, 0)
    Obj:new(PLAYER, ""):SetPos(26.23, 0.2, -13.76, true)
    Obj:new(PLAYER, ""):SetRotationY(100, 0)
    FieldObjectSync(NPC, false)
    WaitFrame(30)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    Field.ObjectPlayMotion(NPC, mirei_index, "e550", 15, true)
    Field.ObjectChangeExpression(NPC, mirei_index, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "010")
    Field.ObjectChangeExpression(NPC, mirei_index, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    tlk:EndTalk(true)
    Qst.Sub:Start(self.ID, 1, false)
    Flg.Set("FLAG_SUB_100_178_002")
    Flg.Clear("FLAG_NOT_USE_FIELD_FADE")
    PlaySE(200001, 100)
    MapChange("t", 3003, "start_00", true, FADE_BLACK, FADE_TIME)
  end
end

function S100_178:Event_020()
  if Qst.Sub:Check(self.ID, self.STEP_001, self.STEP_255) and Flg.Check("FLAG_SUB_100_178_002") then
    Field.ObjectLoadMotion(PLAYER, 1, "fn01_01")
    Field.ObjectLoadMotion(PLAYER, 1, "e002")
    Field.ObjectLoadMotion(PLAYER, 1, "e004_01")
    Field.ObjectLoadMotion(PLAYER, 1, "e005")
    Field.ObjectLoadMotion(PLAYER, 1, "e005_01")
    Field.ObjectLoadMotion(PLAYER, 1, "e008")
    Field.ObjectLoadMotion(PLAYER, 1, "e010")
    Field.ObjectLoadMotion(PLAYER, 1, "e011_01")
    Field.ObjectLoadMotion(PLAYER, 1, "e012")
    Field.ObjectLoadMotion(PLAYER, 1, "e013")
    Field.ObjectLoadMotion(PLAYER, 1, "e015")
    Field.ObjectLoadMotion(PLAYER, 1, "e018")
    Field.ObjectLoadMotion(PLAYER, 1, "e019")
    Field.ObjectLoadMotion(PLAYER, 1, "e033")
    Field.ObjectLoadMotion(PLAYER, 1, "fg07_m01")
    local npc_index_y = GetIndex(NPC, "npc_0002")
    local npc_index_k = GetIndex(NPC, "npc_0003")
    Field.ObjectLoadExpression(NPC, npc_index_y, "F01")
    Field.ObjectLoadExpression(NPC, npc_index_k, "F01")
    PlaySE(200002, 100)
    tlk:StartTalkAndCancelDigimonRide()
    Field.ObjectLookAtTheObject(NPC, npc_index_y, PLAYER, 1, 0)
    Field.ObjectLookAtTheObject(NPC, npc_index_k, PLAYER, 1, 0)
    HideMinimap(true)
    HideGuide(true)
    Cam.Inst:Set(6.4, -0.4, -15.65, 8.93, 1.63, -6.173, default, 0)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "020")
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "030")
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "040")
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "050")
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    local result = tlk:Select(3, base .. "060")
    WaitFrame(15)
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    if result == RESULT_TALK00 then
      tlk:Message(base .. "070")
    elseif result == RESULT_TALK01 then
      tlk:Message(base .. "080")
    elseif result == RESULT_TALK02 then
      tlk:Message(base .. "090")
    end
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "100")
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "110")
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "120")
    tlk:Message(base .. "130")
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    local result = tlk:Select(3, base .. "140")
    WaitFrame(15)
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    if result == RESULT_TALK00 then
      tlk:Message(base .. "150")
    elseif result == RESULT_TALK01 then
      tlk:Message(base .. "160")
    elseif result == RESULT_TALK02 then
      tlk:Message(base .. "170")
    end
    tlk:Message(base .. "180")
    Field.ObjectChangeExpression(NPC, npc_index_k, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "190")
    tlk:Message(base .. "200")
    Field.ObjectChangeExpression(NPC, npc_index_y, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    tlk:EndTalk(true)
    Qst.Sub:Set(self.ID, self.STEP_005)
    Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
    Flg.Set("FLAG_IS_SKIP_FADE_030")
    Flg.Clear("FLAG_IS_MIREI_ADULT")
    PlaySE(200006, 100)
    MapChange("t", 3001, "start_40", true, FADE_WHITE, FADE_TIME)
  end
end

function S100_178:Event_030()
  if Qst.Sub:Check(self.ID, self.STEP_005, self.STEP_255) then
    local mirei_index = GetIndex(NPC, "farm_0001")
    local mirei_index_2 = GetIndex(NPC, "farm_0002")
    Field.ObjectLoadMotion(NPC, mirei_index, "fn01_01")
    Field.ObjectLoadMotion(NPC, mirei_index, "e002")
    Field.ObjectLoadMotion(NPC, mirei_index, "e550")
    Field.ObjectLoadExpression(NPC, mirei_index, "F01")
    Field.ObjectLoadExpression(NPC, mirei_index_2, "F01")
    tlk:StartTalkAndCancelDigimonRide()
    HideMinimap(true)
    HideGuide(true)
    Cam.Inst:Set(-17.9, 0.15, -3.1, -8.85, 1.55, 0.94, default, 0)
    Obj:new(PLAYER, ""):SetPos(-9.63, 0.2, 0.01, true)
    Obj:new(PLAYER, ""):SetRotationY(270, 0)
    FadeAllInWithWait(FADE_WHITE, FADE_TIME)
    Field.ObjectChangeExpression(NPC, mirei_index, "F01", EYES_BLINK_TYPE_BLINK, true, 30, AUTO_CANCEL_NONE, 15)
    tlk:Message(base .. "210")
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, mirei_index, "e002", 10, 10)
    Field.ObjectPlayMotionWithStartMoveMotion(NPC, mirei_index_2, "e002", 10, 10)
    tlk:Message(base .. "220")
    Field.ObjectChangeExpression(NPC, mirei_index, "F01", EYES_BLINK_TYPE_BLINK, false, 30, AUTO_CANCEL_NONE, 15)
    tlk:MessageClose()
    WaitFrame(15)
    OpenTutorial(3021)
    Flg.Set("TUT_FLAG_4721")
    tlk:EndTalk()
    HideMinimap(false)
    HideGuide(false)
    Qst.Sub:End(self.ID, self.STEP_255)
    Flg.Set("FLAG_OPEN_TIMEJUMP")
    local rot = Field.ObjectGetRotationY(FLD_OBJ_PLAYER, 1)
    SetFollowerCameraOperateRotation(0, rot, 0)
    Cam.Inst:Clear(30)
  end
end
