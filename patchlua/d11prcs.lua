gGimText = "field_text"

function Prcs_d1101_CheckControlPanel()
  Cam.Inst:Set(2.175, 0, 32.08, -2, 0.5, 47.08, default, 0)
  WaitFrame(30)
  if not Flg.Check("FLAG_GIMMICK_D11_020") then
    local tlk = Tlk:new(gGimText, 1, false)
    tlk:StartTalk()
    tlk:Message("g_d1101_0010_0010")
    tlk:MessageClose()
    local result = tlk:Select(2, "g_d1101_0020_0010")
    if result == RESULT_TALK00 then
      Flg.Set("FLAG_GIMMICK_D11_020")
      tlk:EndTalk(true)
      PlayerTurnToObject(FLD_OBJ_LOCATOR, "gim_0001", true, false, 0, 0)
      Motion.Player:Play("fg07_m01", 0, false)
      FadeOutWithWait(0, 30)
      PlaySE(200005, 100)
      Cam.Inst:Set(3.74, 0.64, 6.09, 8.8, 4.93, 13.58, default, 0)
      FadeInWithWait(0, 30)
      WaitFrame(30)
      local se_slot = PlaySE(201009, 100)
      Motion.Gimmick:Play("gim_0002", "e001", false)
      WaitFrame(30)
      PlaySE(201003, 100)
      WaitFrame(30)
      Obj:new(GIM, "gim_0005"):Invisible()
      SetControlScriptExternalVariable("elecmon_state", "escape_to400")
      SetControlScriptExternalVariable("elecmon_pos", "130")
      Flg.Clear("FLAG_GIMMICK_D11_220")
      Flg.Clear("FLAG_GIMMICK_D11_221")
      Flg.Clear("FLAG_GIMMICK_D11_222")
      Flg.Set("FLAG_GIMMICK_D11_223")
      Flg.Clear("FLAG_GIMMICK_D11_224")
      FadeOutWithWait(0, 30)
      Cam.Inst:Set(6, 3.63, 42, 10.09, 4.7, 39.16, default, 0)
      FadeInWithWait(0, 30)
      WaitFrame(60)
      StopSE(se_slot, 30)
      WaitFrame(30)
      FadeOutWithWait(0, 30)
      Cam.Inst:Clear(0)
      FadeInWithWait(0, 30)
      ColOn("plan_cl_0001")
      ColOn("plan_cl_0002")
      tlk:StartTalk()
      tlk:Message("g_d1101_0030_0010")
      tlk:EndTalk()
      M060:Event_060()
      M060:Event_065()
    elseif result == RESULT_TALK02 then
      Cam.Inst:Clear(0)
      tlk:EndTalk()
    end
  else
    Cam.Inst:Set(2.175, 0, 32.08, -2, 0.5, 47.08, default, 0)
    WaitFrame(30)
    Field_Talk_Start_Not_LetterBox(gGimText, 1)
    Message("g_d1101_0060_0010")
    Field_Talk_End_Not_LetterBox()
    Cam.Inst:Clear(0)
  end
  Cam.Inst:Clear(0)
  Field_Talk_End_Not_LetterBox()
end

function Prcs_d1101_ChaseCounter()
  local elc_state = GetControlScriptExternalVariableString("elc_state")
  local chase_count = GetControlScriptExternalVariableNumber("chase_count")
  chase_count = chase_count + 1
  SetControlScriptExternalVariable("chase_count", chase_count)
  if 4 < chase_count then
    SetControlScriptExternalVariable("elc_state", "on")
  end
end

function Prcs_d1101_Elecmon_RunAway_Evt()
  Cam.Inst:Set(37.851, 1.3, 43.748, 28.025, 0.569, 42.044, default, 0)
  local index = Field.GetNpcIndex("npc_elecmon")
  Field.ObjectSetPos(FLD_OBJ_NPC, index, 31.644, 0, 44.019)
  Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 90, 0)
  Motion.NPC:Play("npc_elecmon", "ba02", 10, false)
  WaitFrame(20)
  AttachAndStartEffectScript(FLD_OBJ_NPC, GetIndex(FLD_OBJ_NPC, "npc_elecmon"), "ef_b_hit_140_thunder", true, 1, false, false, false, false)
  PlaySE(330131, 100)
  WaitFrame(45)
  Motion.NPC:Play("npc_elecmon", "bn01", 10, true)
  local index = GetIndex(FLD_OBJ_LOCATOR, "sp_0001")
  AttachAndStartEffectScript(FLD_OBJ_LOCATOR, index, "ef_b_hit_140_thunder", true, 2, false, false, false, false)
  PlaySE(330131, 100)
  WaitFrame(40)
  Cam.Inst:Set(25.4, 2.4, 41.5, 16.4, 5.1, 44.7, default, 0)
  WaitFrame(10)
  Motion.Gimmick:Play("obj_0001", "e001", false)
  PlaySE(201005, 100)
  WaitFrame(50)
  ColOff("wall_cl_0009")
  Flg.Set("FLAG_GIMMICK_D11_080")
  Cam.Inst:Clear(0)
end

function Prcs_d1101_Elecmon_Invisible()
  Obj:new(NPC, "npc_elecmon"):Invisible(30)
  SetControlScriptExternalVariable("elecmon_state", "stop")
end

function Prcs_d1101_DoorClose()
  local index1 = Field.GetFollowerIndexByGuestID(GST_HEROINE)
  local index2 = Field.GetFollowerIndexByGuestID(GST_HIROKO)
  Field.ObjectLoadMotion(FLD_OBJ_PLAYER, 1, "e006")
  Field.ObjectLoadMotion(FLD_OBJ_FOLLOWER, index1, "e006")
  Field.ObjectLoadMotion(FLD_OBJ_FOLLOWER, index2, "e006")
  Field_InvisibleFollowerAllPartyMember(0, 15, false)
  local pos1 = Field.ObjectGetPosition(FLD_OBJ_PLAYER, 1)
  local pos2 = Field.ObjectGetPosition(FLD_OBJ_FOLLOWER, index1)
  local pos3 = Field.ObjectGetPosition(FLD_OBJ_FOLLOWER, index2)
  local pos_obj = Field.ObjectGetPosition(FLD_OBJ_LOCATOR, GetIndex(FLD_OBJ_LOCATOR, "obj_0001"))
  local y_degree1 = Field.GetAngleToTarget2D(pos1.x, pos1.z, pos_obj.x, pos_obj.z)
  local y_degree2 = Field.GetAngleToTarget2D(pos2.x, pos2.z, pos_obj.x, pos_obj.z)
  local y_degree3 = Field.GetAngleToTarget2D(pos3.x, pos3.z, pos_obj.x, pos_obj.z)
  Field.ObjectSetPos(FLD_OBJ_FOLLOWER, index1, pos2.x, pos2.y, pos2.z)
  Field.ObjectSetPos(FLD_OBJ_FOLLOWER, index2, pos3.x, pos3.y, pos3.z)
  WaitFrame(5)
  Field.FollowerWarp()
  Cam.Inst:Set(26.229, 0.13, 41.934, 13.616, 2.977, 45.416, default, 0)
  Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, y_degree1, 0)
  Field.ObjectSetRotationY(FLD_OBJ_FOLLOWER, index1, y_degree2, 0)
  Field.ObjectSetRotationY(FLD_OBJ_FOLLOWER, index2, y_degree3, 0)
  WaitFrame(5)
  local index = GetIndex(FLD_OBJ_LOCATOR, "sp_0001")
  AttachAndStartEffectScript(FLD_OBJ_LOCATOR, index, "ef_b_hit_140_thunder", true, 2, false, false, false, false)
  PlaySE(330131, 100)
  WaitFrame(10)
  local index = GetIndex(FLD_OBJ_LOCATOR, "obj_0001")
  Field.ObjectPlayMotionAndSetting(FLD_OBJ_LOCATOR, index, "e001", 5, 60, 60, 0, 1.5, false)
  PlaySE(201005, 100)
  ColOn("wall_cl_0009")
  WaitFrame(25)
  Field.ObjectPlayMotionWithStartMoveMotion(FLD_OBJ_FOLLOWER, index2, "e006", 5, 5)
  WaitFrame(2)
  Field.ObjectPlayMotionWithStartMoveMotion(FLD_OBJ_FOLLOWER, index1, "e006", 5, 5)
  WaitFrame(5)
  Field.ObjectPlayMotionWithStartMoveMotion(FLD_OBJ_PLAYER, 1, "e006", 5, 5)
  WaitFrame(5)
  Quake.Start(0, 0.5, 15)
  WaitFrame(5)
  Quake.Stop()
  WaitFrame(35)
  Field_CancelInvisibleFollowerAllPartyMember(0, 30, false, false)
  Field.ObjectResetMotion(FLD_OBJ_PLAYER, 1, 10)
  Field.ObjectResetMotion(FLD_OBJ_FOLLOWER, index1, 10)
  Field.ObjectResetMotion(FLD_OBJ_FOLLOWER, index2, 10)
  Cam.Inst:Clear(30)
end

function Prcs_d1101_DoorClose_elec()
  local index1 = Field.GetFollowerIndexByGuestID(GST_HEROINE)
  local index2 = Field.GetFollowerIndexByGuestID(GST_HIROKO)
  Field.ObjectLoadMotion(FLD_OBJ_PLAYER, 1, "e006")
  Field.ObjectLoadMotion(FLD_OBJ_FOLLOWER, index1, "e006")
  Field.ObjectLoadMotion(FLD_OBJ_FOLLOWER, index2, "e006")
  Field_InvisibleFollowerAllPartyMember(0, 15, false)
  Cam.Inst:Set(37.851, 1.3, 43.748, 28.025, 0.569, 42.044, default, 0)
  local index = Field.GetNpcIndex("npc_elecmon")
  Field.ObjectSetPos(FLD_OBJ_NPC, index, 31.644, 0, 44.019)
  Field.ObjectSetRotationY(FLD_OBJ_NPC, index, 90, 0)
  Motion.NPC:Play("npc_elecmon", "ba02", 10, false)
  WaitFrame(20)
  local pos1 = Field.ObjectGetPosition(FLD_OBJ_PLAYER, 1)
  local pos2 = Field.ObjectGetPosition(FLD_OBJ_FOLLOWER, index1)
  local pos3 = Field.ObjectGetPosition(FLD_OBJ_FOLLOWER, index2)
  Field.ObjectSetPos(FLD_OBJ_FOLLOWER, index1, pos2.x, pos2.y, pos2.z)
  Field.ObjectSetPos(FLD_OBJ_FOLLOWER, index2, pos3.x, pos3.y, pos3.z)
  local pos_obj = Field.ObjectGetPosition(FLD_OBJ_LOCATOR, GetIndex(FLD_OBJ_LOCATOR, "obj_0001"))
  AttachAndStartEffectScript(FLD_OBJ_NPC, GetIndex(FLD_OBJ_NPC, "npc_elecmon"), "ef_b_hit_140_thunder", true, 1, false, false, false, false)
  PlaySE(330131, 100)
  WaitFrame(30)
  Motion.NPC:Play("npc_elecmon", "bn01", 10, true)
  local index = GetIndex(FLD_OBJ_LOCATOR, "sp_0001")
  AttachAndStartEffectScript(FLD_OBJ_LOCATOR, index, "ef_b_hit_140_thunder", true, 2, false, false, false, false)
  PlaySE(330131, 100)
  WaitFrame(30)
  Cam.Inst:Set(40.583, 0.623, 41.55, 49.897, 3.153, 38.934, default, 0)
  local y_degree1 = Field.GetAngleToTarget2D(pos1.x, pos1.z, pos_obj.x, pos_obj.z)
  local y_degree2 = Field.GetAngleToTarget2D(pos2.x, pos2.z, pos_obj.x, pos_obj.z)
  local y_degree3 = Field.GetAngleToTarget2D(pos3.x, pos3.z, pos_obj.x, pos_obj.z)
  Field.ObjectSetRotationY(FLD_OBJ_PLAYER, 1, y_degree1, 0)
  Field.ObjectSetRotationY(FLD_OBJ_FOLLOWER, index1, y_degree2, 0)
  Field.ObjectSetRotationY(FLD_OBJ_FOLLOWER, index2, y_degree3, 0)
  WaitFrame(10)
  local index = GetIndex(FLD_OBJ_LOCATOR, "obj_0001")
  Field.ObjectPlayMotionAndSetting(FLD_OBJ_LOCATOR, index, "e001", 5, 60, 60, 0, 1.5, false)
  PlaySE(201005, 100)
  ColOn("wall_cl_0009")
  WaitFrame(25)
  Field.ObjectPlayMotionWithStartMoveMotion(FLD_OBJ_FOLLOWER, index2, "e006", 5, 5)
  WaitFrame(2)
  Field.ObjectPlayMotionWithStartMoveMotion(FLD_OBJ_FOLLOWER, index1, "e006", 5, 5)
  WaitFrame(5)
  Field.ObjectPlayMotionWithStartMoveMotion(FLD_OBJ_PLAYER, 1, "e006", 5, 5)
  WaitFrame(5)
  Quake.Start(0, 0.5, 15)
  WaitFrame(5)
  Quake.Stop()
  WaitFrame(35)
  Cam.Inst:Clear(30)
  Obj:new(FLD_OBJ_LOCATOR, "fa_0001"):CancelInvisible()
  Obj:new(FLD_OBJ_LOCATOR, "gim_0004"):CancelInvisible()
  Flg.Set("FLAG_GIMMICK_D11_237")
  Field.ObjectResetMotion(FLD_OBJ_PLAYER, 1, 10)
  Field.ObjectResetMotion(FLD_OBJ_FOLLOWER, index1, 10)
  Field.ObjectResetMotion(FLD_OBJ_FOLLOWER, index2, 10)
  Field_Talk_Start("d11", 1)
  Talk.NextNoVoice()
  Message("f_d1101_0030_0010")
  Field_Talk_End()
  M060:Event_051()
end

function Prcs_d1101_DoorOpen_FA()
  Cam.Inst:Set(76.97, 1.1, 47.75, 73.97, 3, 44.75, default, 0)
  WaitFrame(20)
  local index = GetIndex(FLD_OBJ_LOCATOR, "sp_0004")
  AttachAndStartEffectScript(FLD_OBJ_LOCATOR, index, "ef_b_hit_140_thunder", true, 3, false, false, false, false)
  PlaySE(330131, 100)
  WaitFrame(40)
  Obj:new(FLD_OBJ_LOCATOR, "fa_0001"):Invisible()
  Obj:new(FLD_OBJ_LOCATOR, "gim_0004"):Invisible()
  Cam.Inst:Set(35, 2, 42.5, 45, 3.5, 45, default, 0)
  WaitFrame(10)
  Motion.Gimmick:Play("obj_0001", "e001", false)
  PlaySE(201005, 100)
  WaitFrame(50)
  ColOff("wall_cl_0009")
  Cam.Inst:Clear(0)
  M060:Event_052()
end

function Prcs_d1101_Duct()
  require("d05_01c")
  d05_01c("duct_0001")
  Field_InvisibleFollowerAllPartyMember(0, 0, false)
  Field_InvisibleFollowerAllGuest(0, 0, false)
  PlayerModelChange(AEGIOCHUSMON)
  WaitFrame(5)
  Field.ObjectCheckSync(PLAYER, false)
  SetProhibitPlayerOnlyOperate(true)
  Field.ObjectSetPos(FLD_OBJ_PLAYER, 1, 24.008, 0, 6.732)
  Field.SetPlayerRotation(180, 0)
  SetFollowerCameraOperateRotation(5, -5, 0)
  Flg.Set("FLAG_GIMMICK_D11_233")
  Field.ObjectInvisible(FLD_OBJ_GIMMICK, GetIndex(FLD_OBJ_GIMMICK, "shutter_access01"), 0, 0, false)
  Field.ObjectInvisible(FLD_OBJ_GIMMICK, GetIndex(FLD_OBJ_GIMMICK, "duct_access01"), 0, 0, false)
  WaitFrame(5)
  Cam.Inst:Clear(0)
  FadeInWithWait(0, 15)
  WaitFrame(30)
end

function Prcs_d1101_ControlPanel_210()
  if Flg.Check("FLAG_GIMMICK_D11_231") then
    Cam.Inst:Set(2.175, 0, 32.08, -2, 0.5, 47.08, default, 0)
    WaitFrame(30)
    Field_Talk_Start_Not_LetterBox(gGimText, 1)
    Message("g_d1101_0010_0010")
    Field_Talk_End_Not_LetterBox()
  else
    Cam.Inst:Set(-6.242, -0.05, 34.895, -13.319, 2.841, 41.341, default, 0)
    WaitFrame(30)
    Flg.Set("FLAG_GIMMICK_D11_231")
    SetPlayerRotationToLocator("gim_0001", 10)
    PlaySE(200005, 100)
    local se_slot = PlaySE(201009, 100)
    Motion.Gimmick:Play("gim_0002", "e002", false)
    WaitFrame(180)
    StopSE(se_slot, 30)
    FadeOutWithWait(0, 30)
    ColOff("plan_cl_0001")
    ColOff("plan_cl_0002")
    Cam.Inst:Set(-31.656, 2.284, 13.282, -23.048, 4.112, 18.031, default, 0)
    CancelPlayerModelChange()
    WaitFrame(5)
    Field.ResetPlayer(-37.76, 0, 12.92, 90)
    FieldObjectSync(PLAYER, false)
    Field.ObjectResetMotion(PLAYER, 1, 10)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    FadeInWithWait(0, 30)
    WaitFrame(10)
    Motion.Gimmick:Play("obj_2000", "e001", false)
    ColOff("wall_cl_0008")
    PlaySE(201005, 100)
    WaitFrame(50)
    Field.ObjectInvisible(FLD_OBJ_LOCATOR, GetIndex(FLD_OBJ_LOCATOR, "gim_0001"), 0, 0, false)
    Field.ObjectCancelInvisible(FLD_OBJ_GIMMICK, GetIndex(FLD_OBJ_GIMMICK, "panel_access01"), 0, 0, false, false)
    M210:Event_070()
    Fade_OutNoLoading(0, 15)
    WaitFrame(15)
    Cam.Inst:Clear(0)
    SetProhibitPlayerOnlyOperate(false)
    WaitFrame(5)
    Field.SetPlayerRotation(90, 0)
    SetFollowerCameraOperateRotation(10, 120)
    WaitFrame(5)
    Field_CancelInvisibleFollowerAllGuest(0, 0, false, false)
    Field_CancelInvisibleFollowerAllPartyMember(0, 0, false, false)
    local aegio = Field.GetFollowerIndexForAegiomon()
    local heroine = Field.GetFollowerIndexByGuestID(GST_HEROINE)
    Field.ObjectCancelInvisible(FLD_OBJ_FOLLOWER, heroine, 0, 0, true, true)
    Field.ObjectCancelInvisible(FLD_OBJ_FOLLOWER, aegio, 0, 0, true, true)
    FieldObjectSync(FOR_ALL, false)
    FadeInWithWait(0, 15)
    WaitFrame(15)
    M210:Event_075()
    Field_CancelInvisibleFollowerAllGuest(0, 0, false, false)
    Field_CancelInvisibleFollowerAllPartyMember(0, 0, false, false)
  end
end

function Prcs_d1101_DoorPanel()
  Cam.Inst:Set(25.4, 2.4, 41.5, 16.4, 5.1, 44.7, default, 0)
  WaitFrame(10)
  PlayerTurnToObject(FLD_OBJ_GIMMICK, "panel_access01", true, false, 0, 0)
  Motion.Player:Play("fg07_m01", 0, false)
  WaitFrame(30)
  Motion.Gimmick:Play("obj_0001", "e001", false)
  PlaySE(201005, 100)
  WaitFrame(50)
  ColOff("wall_cl_0009")
  Flg.Set("FLAG_GIMMICK_D11_232")
  Field.ObjectSetEnableCheckAndFieldAttack(FLD_OBJ_GIMMICK, GetIndex(FLD_OBJ_GIMMICK, "panel_access01"), false)
  Cam.Inst:Clear(0)
end

function Prcs_d1102_BS_Invisible()
  local index = Field.GetNpcIndex("npc_blackshadow")
  local pos = Field.ObjectGetPosition(NPC, index)
  Obj:new(NPC, "npc_blackshadow"):Invisible(10)
end

function Prcs_d1102_BS_CancelInvisible()
  local index = Field.GetNpcIndex("npc_blackshadow")
  local pos = Field.ObjectGetPosition(NPC, index)
  Obj:new(NPC, "npc_blackshadow"):CancelInvisible(5)
end

function Prcs_d1102_BS_DoorEffect()
  Field.PlayEffectScript("ef_f_com_300_sm", 47.5, 4.9, 19, 0, 1)
end

function Prcs_d1102_210_DoorOpen()
  Field.ObjectLoadMotion(FLD_OBJ_GIMMICK, GetIndex(FLD_OBJ_GIMMICK, "door01"), "e001")
  Cam.Inst:Set(-1.016, 2.183, -6.188, 7.921, 5.144, -9.55, default, 0)
  WaitFrame(10)
  Field.ObjectPlayMotion(FLD_OBJ_GIMMICK, GetIndex(FLD_OBJ_GIMMICK, "door01"), "e001", 0, false)
  PlaySE(201005, 100)
  WaitFrame(50)
  Cam.Inst:Clear(0)
  Field.ObjectInvisible(FLD_OBJ_GIMMICK, GetIndex(FLD_OBJ_GIMMICK, "door01"), 0, 0, false)
  Flg.Set("FLAG_GIMMICK_D11_234")
end
