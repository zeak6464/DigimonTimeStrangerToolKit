S110_099 = {
  ID = 99,
  STEP_001 = 1,
  STEP_005 = 5,
  STEP_255 = 255,
  Flg01 = "FLAG_SUB_110_099_001",
  Flg02 = "FLAG_SUB_110_099_002",
  Flg03 = "FLAG_SUB_110_099_003",
  Flg04 = "FLAG_SUB_110_099_004"
}
local text_file = "s110_099"
local base = "s110_099_"

function S110_099:Event_010()
  if Qst.Main:IsCompleted(M240.ID) and Qst.Sub:IsAllCompleted({39, 77}) and not Qst.Sub:IsCompleted(self.ID) and not Qst.Sub:Check(self.ID, self.STEP_005) then
    local tlk = Tlk:new(text_file, 1, true)
    tlk:StartTalkActionAndZoom("s110_099_001")
    tlk:Message(base .. "010")
    local result = tlk:Select(2, base .. "020")
    if result == RESULT_TALK00 then
      tlk:Message(base .. "030")
      tlk:Message(base .. "040")
      tlk:Message(base .. "050")
    elseif result == RESULT_TALK01 then
      tlk:Message(base .. "060")
    end
    tlk:EndTalkActionAndZoom()
  end
end

function S110_099:Event_020()
  if Qst.Main:IsCompleted(M240.ID) and Qst.Sub:IsAllCompleted({39, 77}) and not Qst.Sub:IsCompleted(self.ID) and not Qst.Sub:Check(self.ID, self.STEP_005) then
    if Guest.IsExistNum(3) then
      INFO_WINDOW(10050)
      return
    end
    local duke_index = GetIndex(NPC, "s110_099_001")
    local fq01 = Motion.Object:new(NPC, "s110_099_001", "fq01")
    local fe04 = Motion.Object:new(NPC, "s110_099_001", "fe04")
    local fq02 = Motion.Object:new(NPC, "s110_099_001", "fq02")
    local bn01 = Motion.Object:new(NPC, "s110_099_001", "bn01")
    local br01 = Motion.Object:new(NPC, "s110_099_001", "br01")
    local e002 = Motion.Object:new(PLAYER, "", "e002")
    local e004 = Motion.Object:new(PLAYER, "", "e004")
    local e008 = Motion.Object:new(PLAYER, "", "e008")
    local e012 = Motion.Object:new(PLAYER, "", "e012")
    local fn01_01 = Motion.Object:new(PLAYER, "", "fn01_01")
    Fade_OutNoLoadingWithWait(FADE_BLACK, FADE_TIME)
    local tlk = Tlk:new(text_file, 1, true)
    Cam.Inst:Set(-63.764, -6.24, 64.88, -65.3, -9.43, 55.53, default, 0)
    Obj:new(PLAYER, ""):SetPos(-65.19, -10.385, 59.447)
    Obj:new(PLAYER, ""):SetRotationY(150, 0)
    HideMinimap(true)
    HideGuide(true)
    tlk:StartTalkAndCancelDigimonRide()
    local duke_pos = Field.ObjectGetPosition(NPC, duke_index)
    local player_pos = Field.ObjectGetPosition(PLAYER, 1)
    local y_degree = GetAngleToTarget2D(duke_pos.x, duke_pos.z, player_pos.x, player_pos.z)
    Field.ObjectSetRotationY(NPC, duke_index, y_degree, 0)
    WaitFrame(15)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    if not Flg.Check(self.Flg01) then
      Flg.Set(self.Flg01)
      tlk:Message(base .. "070")
      local result = tlk:Select(3, base .. "080")
      WaitFrame(15)
      if result == RESULT_TALK00 then
        fq01:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "090")
      elseif result == RESULT_TALK01 then
        fq01:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "100")
      elseif result == RESULT_TALK02 then
        tlk:Message(base .. "110")
      end
      fq02:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "120")
      fe04:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "130")
      result = tlk:Select(3, base .. "140")
      WaitFrame(15)
      if result == RESULT_TALK00 then
        fq01:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "150")
      elseif result == RESULT_TALK01 then
        fq02:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "160")
      elseif result == RESULT_TALK02 then
        fq02:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "170")
      end
      fe04:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "180")
      fq02:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "190")
      fq01:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "200")
      result = tlk:Select(2, base .. "210")
      WaitFrame(15)
      if result == RESULT_TALK00 then
        fe04:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "220")
      elseif result == RESULT_TALK01 then
        fq02:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "230")
        tlk:EndTalk()
        HideMinimap(false)
        HideGuide(false)
        Cam.Inst:Clear(30)
        WaitFrame(30)
        goto lbl_590
      end
      Flg.Set(self.Flg04)
      fq01:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "240")
      tlk:EndTalk(true)
      Qst.Sub:Set(self.ID, self.STEP_005)
      Qst.Sub:Start(self.ID, 1, false)
      Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
      Flg.Set("FLAG_IS_NOT_MAP_NAME_DISP")
      MapChange("d", 503, "start_21", true, FADE_BLACK, FADE_TIME)
    else
      Cam.Inst:Set(-63.764, -6.24, 64.88, -65.3, -9.43, 55.53, default, 30)
      WaitFrame(30)
      local tlk = Tlk:new(text_file, 1, true)
      fe04:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "180")
      fq02:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "190")
      fq01:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "200")
      local result = tlk:Select(2, base .. "210")
      WaitFrame(15)
      if result == RESULT_TALK00 then
        fe04:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "220")
      elseif result == RESULT_TALK01 then
        fq02:PlayWithStartMoveMotion(10, 10)
        tlk:Message(base .. "230")
        tlk:EndTalk()
        HideMinimap(false)
        HideGuide(false)
        Cam.Inst:Clear(30)
        WaitFrame(30)
        goto lbl_590
      end
      Flg.Set(self.Flg04)
      fq01:PlayWithStartMoveMotion(10, 10)
      tlk:Message(base .. "240")
      tlk:EndTalk(true)
      Qst.Sub:Start(self.ID, 1, false)
      Qst.Sub:Set(self.ID, self.STEP_005)
      Flg.Set("FLAG_SKIP_AREACHANGE_MOVE")
      Flg.Set("FLAG_IS_NOT_MAP_NAME_DISP")
      MapChange("d", 503, "start_21", true, FADE_BLACK, FADE_TIME)
    end
  end
  ::lbl_590::
end

function S110_099:Event_030()
  if Qst.Sub:Check(self.ID, self.STEP_005, self.STEP_255) and not Flg.Check(self.Flg02) then
    Field.ObjectLoadMotion(PLAYER, 1, "e201")
    Field.ObjectLoadMotion(PLAYER, 1, "fn01_01")
    Field.ObjectLoadMotion(PLAYER, 1, "e002")
    Field.ObjectLoadMotion(PLAYER, 1, "e009")
    Field.ObjectLoadMotion(PLAYER, 1, "e009_01")
    Field.ObjectLoadMotion(PLAYER, 1, "e018")
    local gdoramon_index = GetIndex(NPC, "s110_099_groundoramon_01")
    local duke_index = GetIndex(NPC, "s110_099_dukemon_01")
    local k_fq01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fq01")
    local k_fe04 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fe04")
    local k_fq02 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fq02")
    local k_bn01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "bn01")
    local k_bg01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "bg01")
    local k_r01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "br01")
    local p_e018 = Motion.Object:new(PLAYER, "", "e018")
    local p_fn01_01 = Motion.Object:new(PLAYER, "", "fn01_01")
    local d_fq01 = Motion.Object:new(NPC, "s110_099_groundoramon_01", "fq01")
    local d_fe02 = Motion.Object:new(NPC, "s110_099_groundoramon_01", "fe02")
    local d_fe04 = Motion.Object:new(NPC, "s110_099_groundoramon_01", "fe04")
    local d_fq02 = Motion.Object:new(NPC, "s110_099_groundoramon_01", "fq02")
    local d_bn01 = Motion.Object:new(NPC, "s110_099_groundoramon_01", "bn01")
    local d_r01 = Motion.Object:new(NPC, "s110_099_groundoramon_01", "br01")
    local gdoramon_pos = Field.ObjectGetPosition(NPC, gdoramon_index)
    local player_pos = Field.ObjectGetPosition(PLAYER, 1)
    local y_degree = GetAngleToTarget2D(gdoramon_pos.x, gdoramon_pos.z, player_pos.x, player_pos.z)
    Field.ObjectLoadExpression(PLAYER, 1, "F16")
    local tlk = Tlk:new(text_file, 1, true)
    tlk:StartTalkAndCancelDigimonRide()
    WaitFrame(5)
    HideMinimap(true)
    WaitFrame(5)
    HideGuide(true)
    Field_InvisibleFollowerAllPartyMember(0, 0, false)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    Cam.Inst:Set(8.864, 0.036, 65.982, 18.6146, 1.5689, 64.3768, default, 0)
    local rot = Field.ObjectGetRotationY(FLD_OBJ_PLAYER, 1)
    MovePlayerFrame(rot, 6, 25)
    WaitFrame(15)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    WaitFrame(15)
    Field.ObjectPlayMotionWithStartMoveMotion(PLAYER, 1, "e201", 10, 10)
    WaitFrame(100)
    Field.ObjectPlayMotionWithStartMoveMotion(PLAYER, 1, "fn01_01", 10, 10)
    Field.ObjectChangeExpression(PLAYER, 1, "F16", -1, false, 0)
    WaitFrame(30)
    Fade_OutNoLoadingWithWait(FADE_BLACK, FADE_TIME)
    Cam.Inst:Set(51.54, 2.16, 42.79, 42.41, 1.98, 46.85, default, 0)
    Obj:new(PLAYER, ""):SetPos(42.31, 0, 44.5)
    Obj:new(PLAYER, ""):SetRotationY(90, 0)
    MovePlayerFrame(rot, 6, 30)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    local rot = Field.ObjectGetRotationY(FLD_OBJ_PLAYER, 1)
    WaitFrame(30)
    p_e018:Play(10, true)
    d_fe02:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "250")
    k_fe04:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "260")
    d_fe04:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "270")
    tlk:EndTalk(true)
    Flg.Set(self.Flg02)
    Guest.Add(GST_S010_156_DUKE)
    EncountFromField_WithNormalEffect(21100990, 10572, false)
  end
end

function S110_099:Event_040()
  if Qst.Sub:Check(self.ID, self.STEP_005, self.STEP_255) and Flg.Check("FLAG_SUB_110_099_007", self.Flg03) then
    local tlk = Tlk:new(text_file, 1, true)
    local gdoramon_index = GetIndex(NPC, "s110_099_groundoramon_01")
    local duke_index = GetIndex(NPC, "s110_099_dukemon_01")
    local k_fq01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fq01")
    local k_fe02 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fe02")
    local k_fe04 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fe04")
    local k_fq02 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fq02")
    local k_bn01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "bn01")
    local k_bg01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "bg01")
    local k_r01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "br01")
    local d_fq01 = Motion.Object:new(NPC, "s110_099_groundoramon_02", "fq01")
    local d_fe02 = Motion.Object:new(NPC, "s110_099_groundoramon_02", "fe02")
    local d_fe04 = Motion.Object:new(NPC, "s110_099_groundoramon_02", "fe04")
    local d_fq02 = Motion.Object:new(NPC, "s110_099_groundoramon_02", "fq02")
    local d_bn01 = Motion.Object:new(NPC, "s110_099_groundoramon_02", "bn01")
    local d_r01 = Motion.Object:new(NPC, "s110_099_groundoramon_02", "br01")
    local p_e018 = Motion.Object:new(PLAYER, "", "e018")
    local p_fn01_01 = Motion.Object:new(PLAYER, "", "fn01_01")
    HideMinimap(true)
    p_fn01_01:Play(10, true)
    WaitFrame(5)
    HideGuide(true)
    WaitFrame(5)
    tlk:StartTalkAndCancelDigimonRide()
    FieldObjectSync(NPC, false)
    Field_InvisibleFollowerAllPartyMember(0, 0, false)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    k_fq02:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "280")
    k_fq01:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "290")
    tlk:MessageClose()
    Fade_OutNoLoadingWithWait(FADE_BLACK, FADE_TIME)
    WaitFrame(30)
    Obj:new(PLAYER, ""):SetRotationY(140, 0)
    Obj:new(NPC, "s110_099_dukemon_01"):SetRotationY(315, 0)
    Cam.Inst:Set(52.02, 3.06, 47.67, 47.13, 0.515, 39.326, default, 0)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    k_fe04:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "300")
    local result = tlk:Select(3, base .. "310")
    WaitFrame(15)
    k_fq01:PlayWithStartMoveMotion(10, 10)
    if result == RESULT_TALK00 then
      tlk:Message(base .. "320")
    elseif result == RESULT_TALK01 then
      tlk:Message(base .. "330")
    elseif result == RESULT_TALK02 then
      tlk:Message(base .. "340")
    end
    tlk:Message(base .. "350")
    tlk:Message(base .. "355")
    Flg.Set("FLAG_SUB_110_099_006")
    Fade_OutNoLoadingWithWait(FADE_BLACK, FADE_TIME)
    FieldObjectSync(NPC, false)
    Cam.Inst:Set(51.54, 2.16, 42.79, 42.41, 1.98, 46.85, default, 0)
    Obj:new(PLAYER, ""):SetRotationY(60, 0)
    Obj:new(NPC, "s110_099_dukemon_01"):SetRotationY(30, 0)
    WaitFrame(30)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    p_e018:Play(10, true)
    d_fe04:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "360")
    k_fe02:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "370")
    tlk:EndTalk(true)
    Guest.Add(GST_S010_156_DUKE)
    EncountFromField_WithNormalEffect(21100991, 10572, false)
  end
end

function S110_099:Event_050()
  if Qst.Sub:Check(self.ID, self.STEP_005, self.STEP_255) and Flg.Check(self.Flg03) then
    local tlk = Tlk:new(text_file, 1, true)
    local duke_index = GetIndex(NPC, "s110_099_dukemon_01")
    local k_fq01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fq01")
    local k_fe02 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fe02")
    local k_fe04 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fe04")
    local k_fq02 = Motion.Object:new(NPC, "s110_099_dukemon_01", "fq02")
    local k_bn01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "bn01")
    local k_bg01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "bg01")
    local k_r01 = Motion.Object:new(NPC, "s110_099_dukemon_01", "br01")
    local p_e018 = Motion.Object:new(PLAYER, "", "e018")
    local p_fn01_01 = Motion.Object:new(PLAYER, "", "fn01_01")
    p_fn01_01:Play(10, true)
    HideMinimap(true)
    WaitFrame(5)
    HideGuide(true)
    WaitFrame(5)
    tlk:StartTalkAndCancelDigimonRide()
    Guest.Delete(GST_S010_156_DUKE)
    FieldObjectSync(NPC, false)
    Field_InvisibleFollowerAllPartyMember(0, 0, false)
    Field_InvisibleFollowerAllGuest(0, 0, false)
    Obj:new(PLAYER, ""):SetRotationY(140, 0)
    Obj:new(NPC, "s110_099_dukemon_01"):SetRotationY(315, 0)
    Cam.Inst:Set(52.02, 3.06, 47.67, 47.13, 0.515, 39.326, default, 0)
    FadeAllInWithWait(FADE_BLACK, FADE_TIME)
    k_fe04:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "420")
    tlk:Message(base .. "430")
    k_fq01:PlayWithStartMoveMotion(10, 10)
    tlk:Message(base .. "440")
    tlk:EndTalk(true)
    HideMinimap(false)
    HideGuide(false)
    Qst.Sub:End(self.ID, self.STEP_255)
    require("S100_087")
    Flg.Set(S100_087.Flgs.Flg02)
    S100_087.AddReturnRoyalKnightsNum()
    S100_087:Event_020()
    WaitFrame(75)
    Flg.Clear("FLAG_IS_NOT_MAP_NAME_DISP")
    MapChange("d", 501, "start_00", true, FADE_BLACK, FADE_TIME)
  end
end

function S110_099:Event_060()
  local tlk = Tlk:new(text_file, 1, true)
  tlk:StartTalkAndCancelDigimonRide()
  tlk:Message(base .. "450")
  local result = tlk:Select(2, base .. "460")
  if result == RESULT_TALK00 then
    tlk:Message(base .. "470")
    tlk:EndTalk()
    Field.StartCardGameWithNPC(1254, true)
  else
    tlk:EndTalk()
  end
end
